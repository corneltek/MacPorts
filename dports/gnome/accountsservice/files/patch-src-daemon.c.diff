diff -ur src.orig/daemon.c src/daemon.c
--- src.orig/daemon.c	2013-06-11 08:50:37.000000000 -0700
+++ src/daemon.c	2013-09-17 12:17:33.000000000 -0700
@@ -49,9 +49,9 @@
 #define PATH_SHADOW "/etc/shadow"
 #define PATH_NOLOGIN "/sbin/nologin"
 #define PATH_FALSE "/bin/false"
-#define PATH_GDM_CUSTOM "/etc/gdm/custom.conf"
+#define PATH_GDM_CUSTOM "@@MP_PREFIX@@/etc/gdm/custom.conf"
 #ifdef HAVE_UTMPX_H
-#define PATH_WTMP _PATH_WTMPX
+#define PATH_WTMP _PATH_UTMPX
 #endif
 
 static const char *default_excludes[] = {
@@ -406,6 +406,22 @@
                            gpointer   *state)
 {
         struct passwd *pwent;
+#ifdef __APPLE__
+
+        /* First iteration */
+        if (*state == NULL) {
+                setpwent();
+		*state = 1;
+        }
+
+        /* Every iteration */
+        pwent = getpwent ();
+        if (pwent != NULL) {
+                return pwent;
+        }
+
+        /* Last iteration */
+#else
         FILE *fp;
 
         /* First iteration */
@@ -426,6 +442,7 @@
 
         /* Last iteration */
         fclose (fp);
+#endif
         *state = NULL;
         return NULL;
 }

--- gui/simple-greeter/gdm-user-manager.c.orig	2011-03-28 09:48:50.000000000 -0700
+++ gui/simple-greeter/gdm-user-manager.c	2013-07-06 14:00:57.000000000 -0700
@@ -2161,7 +2161,6 @@
                     GSList    **added_users,
                     GSList    **removed_users)
 {
-        FILE           *fp;
         GHashTableIter  iter;
         GHashTable     *new_users_by_name;
         GdmUser        *user;
@@ -2173,11 +2172,6 @@
                                                    g_object_unref);
 
         errno = 0;
-        fp = fopen (PATH_PASSWD, "r");
-        if (fp == NULL) {
-                g_warning ("Unable to open %s: %s", PATH_PASSWD, g_strerror (errno));
-                goto out;
-        }
 
         /* Make sure we keep users who are logged in no matter what. */
         g_hash_table_iter_init (&iter, current_users_by_name);
@@ -2229,9 +2223,9 @@
 
                 g_debug ("GdmUserManager: include_all is TRUE");
 
-                for (pwent = fgetpwent (fp);
+                for (pwent = getpwent ();
                      pwent != NULL;
-                     pwent = fgetpwent (fp)) {
+                     pwent = getpwent ()) {
 
                         /* Skip users below MinimalUID... */
                         if (pwent->pw_uid < FALLBACK_MINIMAL_UID) {
@@ -2306,7 +2300,7 @@
  out:
         /* Cleanup */
 
-        fclose (fp);
+        setpwent();
 
         g_hash_table_iter_init (&iter, new_users_by_name);
         while (g_hash_table_iter_next (&iter, (gpointer *) &name, (gpointer *) &user)) {

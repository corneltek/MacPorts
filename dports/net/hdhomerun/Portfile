# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                hdhomerun
version             20140604
set firm_version    ${version}
categories          net multimedia
platforms           darwin
supported_archs     i386 x86_64
license             LGPL-3+
maintainers         ctreleaven openmaintainer
description         HDHomeRun configuration utility
long_description    Provides a library and utility program to access, configure and test \
                    HDHomeRun network tuner devices from SiliconDust.  May also be used to \
                    upgrade firmware. Command line-driven and scriptable.
homepage            http://www.silicondust.com/

master_sites        http://download.silicondust.com/hdhomerun
distname            lib${name}_${version}
patchfiles          patch-01-Makefile-libpath.diff patch-02-Makefile-universal.diff
patch.args          -p1
extract.suffix      .tgz
distfiles-append    ${name}_atsc_firmware_${firm_version}.bin \
                    ${name}_dvbt_firmware_${firm_version}.bin \
                    ${name}3_atsc_firmware_${firm_version}.bin \
                    ${name}3_dvbt_firmware_${firm_version}.bin \
                    ${name}3_dvbtc_firmware_${firm_version}.bin \
                    ${name}3_dvbc_firmware_${firm_version}.bin \
                    ${name}3_cablecard_firmware_${firm_version}.bin \
                    ${name}tc_atsc_firmware_${firm_version}.bin \
                    ${name}4_atsc_firmware_${firm_version}.bin

extract.only        ${distname}${extract.suffix}
worksrcdir          lib${name}
checksums           libhdhomerun_20140604.tgz \
                    rmd160  d141addc60ad555500f95863c58de196ed26ed53 \
                    sha256  b01fb5df86b769e958359719f7312eabdb8e642a1c2cb78d454b28cf87c3330d \
                    hdhomerun_atsc_firmware_20140604.bin \
                    rmd160  0c3b1038f3c4249a8575742b95bedf9788c734fb \
                    sha256  a96e1c3049cd8ac6b97fde0de87af69836d9331529a486f7bb772e28019b4b69 \
                    hdhomerun_dvbt_firmware_20140604.bin \
                    rmd160  b4576f67b56769ccbc80e6ec5c5aaec4bb9aecd4 \
                    sha256  c2abaa917c61e6e0065a32256f249510241783b55e51fded6677c10457420677 \
                    hdhomerun3_atsc_firmware_20140604.bin \
                    rmd160  c55229473d71eedc5e54f1ff73d557a3f70f8503 \
                    sha256  9e02b89d980cf617ceb12a51e3846120ef4864583d5b3861c2313db58582a946 \
                    hdhomerun3_dvbt_firmware_20140604.bin \
                    rmd160  ef7f5b245226aed489d8b7acf6d402b721325945 \
                    sha256  f3f82d8db5cf4e2a7b194d1de5fb77c9066df7f887ff8319e47b0b9e6481b443 \
                    hdhomerun3_dvbtc_firmware_20140604.bin \
                    rmd160  453c731dd92f3c1354863cb8ec06c2dda1e9423c \
                    sha256  62e2edc9801d21a12a1778d06b8d7de5f1b73c511baa5a23af4062bd792ec31e \
                    hdhomerun3_dvbc_firmware_20140604.bin \
                    rmd160  e493ba790033ee9aca190672509162add62fd623 \
                    sha256  bca74a12e1b4126a322afbf7d90c152e9459723032662cc72c107f520182034d \
                    hdhomerun3_cablecard_firmware_20140604.bin \
                    rmd160  96d61e3f8a1a3f37458f7d2d2cb121b2c30aae80 \
                    sha256  9c108868cbb051b119c0f5e5bcec3d451eb5d42942a83a413bf40499e1b0a91f \
                    hdhomeruntc_atsc_firmware_20140604.bin \
                    rmd160  112b194f741976ba315c57de84efc3848ff39a81 \
                    sha256  4a79b0246281f862fd8d76665e7e2d417da837aada4e63cb3ea2d11bbc706d1c \
                    hdhomerun4_atsc_firmware_20140604.bin \
                    rmd160  cfe44b4cfb66ba858bcae0b70102c4c486509ce1 \
                    sha256  182a2c7359b832deed00d697ed43a98c245da526d702a59b54d12224671e8f39

livecheck.type      regex
livecheck.url       http://www.silicondust.com/support/hdhomerun/downloads/
livecheck.regex     Current release: (\[0-9\]+)

use_configure       no

post-patch {
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/Makefile
}

build.args-append   CC=${configure.cc} \
                    CXX=${configure.cxx} \
                    CPP=${configure.cpp}
if {[variant_isset universal]} {
    build.args-append   CFLAGS="${configure.universal_cflags}"
} else {
    build.args-append   CFLAGS="${configure.cc_archflags}"
}

destroot {
    xinstall -m 0755 ${worksrcpath}/hdhomerun_config \
        ${destroot}${prefix}/bin/hdhomerun_config
    xinstall -m 0755 ${worksrcpath}/libhdhomerun.dylib \
        ${destroot}${prefix}/lib/libhdhomerun.dylib
    xinstall -m 0644 -W ${worksrcpath} \
            hdhomerun.h hdhomerun_os.h hdhomerun_os_posix.h \
            hdhomerun_types.h hdhomerun_pkt.h hdhomerun_sock.h \
            hdhomerun_debug.h hdhomerun_discover.h hdhomerun_control.h \
            hdhomerun_video.h hdhomerun_channels.h hdhomerun_channelscan.h \
            hdhomerun_device.h hdhomerun_device_selector.h \
        ${destroot}${prefix}/include/
    xinstall -d -m 0755 ${destroot}${prefix}/share/${name}/
    foreach firm [glob ${distpath}/${name}*firmware_${firm_version}.bin] {
        set firm [lindex [split ${firm} /] end]
        xinstall -m 0644 ${distpath}/${firm} ${destroot}${prefix}/share/${name}/${firm}
    }
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/
    xinstall -m 0644 ${worksrcpath}/README \
        ${destroot}${prefix}/share/doc/${name}/README
}

notes   "
Documentation available at: http://www.silicondust.com/hdhomerun/hdhomerun_development.pdf
To upgrade device to newest firmware run:
    hdhomerun_config <id> upgrade ${prefix}/share/${name}/<firmware>
Choose the correct <firmware> based on your model of HDHomerun device:
HDHR-US (hdhomerun_atsc_firmware_${firm_version}.bin)
HDHR-EU (hdhomerun_dvbt_firmware_${firm_version}.bin)
HDHR3-US (hdhomerun3_atsc_firmware_${firm_version}.bin)
HDHR3-DT (hdhomerun3_dvbt_firmware_${firm_version}.bin)
HDHR3-EU (hdhomerun3_dvbtc_firmware_${firm_version}.bin)
HDHR3-CC (hdhomerun3_cablecard_firmware_${firm_version}.bin)
HDHR3-4DC (hdhomerun3_dvbc_firmware_${firm_version}.bin)
HDTC-2US (hdhomeruntc_atsc_firmware_${firm_version}.bin)
HDHR4-2US (hdhomrun4_atsc_firmware_${firm_version}.bin)
"

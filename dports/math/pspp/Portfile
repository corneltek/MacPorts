# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0
PortGroup               app 1.0

name                    pspp
version                 0.8.0
revision                1
categories              math
license                 GPL-3+
maintainers             snc
conflicts               pspp-devel
description             Statistical analysis of sampled data (free \
                        replacement for SPSS).
long_description        PSPP is a program for \
                        statistical analysis of sampled data. It is a Free \
                        replacement for the proprietary program SPSS, and \
                        appears very similar to it with a few exceptions.

homepage                http://www.gnu.org/software/pspp/
platforms               darwin
master_sites            gnu

checksums           rmd160  56ec2f87494d2e74dfbb36fa0d07ba1971c91260 \
                    sha256  d8574aed32b4c951f650b90e847901f6609c27a4cc295bfd23939385fe58f3dd

depends_lib-append  port:cairo \
                    port:fontconfig \
                    port:freetype \
                    port:gsl \
                    port:libiconv \
                    port:libxml2 \
                    port:ncurses \
                    port:pango \
                    port:readline \
                    port:zlib

distname            ${name}-${version}a
worksrcdir          ${name}-${version}

configure.args      --disable-rpath \
                    --without-libpq \
                    --without-gui \
                    --with-packager=snc \
                    --with-packager-version=${version} \
                    --with-packager-bug-reports=${maintainers}

set nif_compilers {macports-llvm-gcc-4.2 llvm-gcc-4.2}
if {[lsearch -exact ${nif_compilers} ${configure.compiler}] > -1} {
    configure.cflags-append -fno-inline-functions
}

patchfiles              patch-config.h.in.diff

test.run                yes
test.target             check

variant help requires gui description {Provide in-application help via yelp} {
    depends_run-append  port:yelp
}

variant doc description {Build documentation} {
    build.target-append  html
}

variant postgres description {Enables reading of postgresql databases} {
    depends_lib-append  port:postgresql92
    configure.args-delete   --without-libpq
    configure.ldflags-append -L${prefix}/lib/postgresql92
    configure.env-append    PG_CONFIG=${prefix}/lib/postgresql92/bin/pg_config
}

variant gui description {Build PSPPIRE, the graphical interface} {
    depends_lib-append      port:atk \
                            port:gdk-pixbuf2 \
                            port:glib2 \
                            port:gtk2 \
                            port:gtksourceview2

    configure.args-delete   --without-gui
}

variant quartz requires gui conflicts x11 {}
variant x11 requires gui conflicts quartz {
    depends_lib-append  port:xorg-libX11 \
                        port:xorg-libXau \
                        port:xorg-libXcomposite \
                        port:xorg-libXcursor \
                        port:xorg-libXdamage \
                        port:xorg-libXdmcp \
                        port:xorg-libXext \
                        port:xorg-libXfixes \
                        port:xorg-libXi \
                        port:xorg-libXinerama \
                        port:xorg-libXrandr \
                        port:xorg-libxcb \
                        port:xrender
}
if {![variant_isset x11] && ![variant_isset quartz]} {
    if {${os.major} < 11} {
        default_variants +x11
    } else {
        default_variants +quartz
    }
}

post-destroot {
    if {[variant_isset doc]} {
        xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
        foreach fl [glob -nocomplain -directory ${worksrcpath}/doc *.pdf *.html] {
            copy ${fl} ${destroot}${prefix}/share/doc/${name}
        }
    }
}

post-activate {
    system "${prefix}/bin/gtk-update-icon-cache --ignore-theme-index ${prefix}/share/icons/hicolor"

}

post-deactivate {
    system "${prefix}/bin/gtk-update-icon-cache --ignore-theme-index ${prefix}/share/icons/hicolor"
}

if {![variant_isset gui]} {
    app.create      no
}
app.name            PSPP
app.executable      psppire
app.icon            ${filespath}/logo.png

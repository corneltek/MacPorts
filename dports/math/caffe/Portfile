# -*- coding: utf-8; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           github 1.0

github.setup        BVLC caffe e3c895baac64c7c2da4f30ab7ae35a1c84e63733
version             20150131
categories          math science
maintainers         hum openmaintainer

description         a fast framework for deep learning (this port is for CPU-only)
long_description    ${description}

homepage            http://caffe.berkeleyvision.org/
platforms           darwin
license             BSD

checksums           rmd160  2ab530b22e986822dc6460193cd4f7cdfdceb47b \
                    sha256  6cd67cd280edc4ad934b51004cfc0285569b1d58f18d283c9f97cd493133e672

depends_lib-append  port:google-glog \
                    port:gflags \
                    port:protobuf-cpp \
                    port:leveldb \
                    port:snappy \
                    port:lmdb \
                    port:boost \
                    port:hdf5 \
                    port:opencv \
                    port:szip

depends_run-append  port:wget

patchfiles          patch-Makefile.diff \
                    patch-Makefile.conf.diff

post-extract {
    copy ${worksrcpath}/Makefile.config.example ${worksrcpath}/Makefile.config
}

use_configure       no

variant universal {}

set defs "-DGTEST_HAS_TR1_TUPLE=0 -DGTEST_USE_OWN_TR1_TUPLE=0"
build.args          CXX="${configure.cxx}" \
                    _CXXFLAGS="${configure.cxxflags} [get_canonical_archflags cxx] ${defs}" \
                    _PREFIX=${prefix}
                    
set caffe_root ${prefix}/libexec/${name}

destroot {
    # copy files to caffe_root
    xinstall -m 755 -d ${destroot}${caffe_root}
    foreach dir {data examples models python scripts tools} {
        copy ${worksrcpath}/${dir} ${destroot}${caffe_root}
    }
    copy ${worksrcpath}/.build_release ${destroot}${caffe_root}/build

    # install additional documents
    set docdir ${prefix}/share/doc/${name}
    xinstall -m 755 -d ${destroot}${docdir}
    xinstall -m 644 -W ${worksrcpath} \
        CONTRIBUTORS.md LICENSE README.md \
        ${destroot}${docdir}
}

notes "
To try examples, copy ${caffe_root} and run commands.
This port is for CPU-only. Do not forget to train on CPU, not on GPU.
"

default_variants    +python27 +openblas

variant openblas description {Use OpenBLAS} {
    depends_lib-append port:OpenBLAS
    patchfiles-append  patch-openblas.diff
}

variant python27 description {Install Python 2.7 interface} {
    depends_lib-append \
                    port:python27 \
                    port:py27-cython \
                    port:py27-numpy \
                    port:py27-scipy \
                    port:py27-scikit-image \
                    port:py27-scikit-learn \
                    port:py27-matplotlib \
                    port:py27-ipython \
                    port:py27-h5py \
                    port:py27-networkx \
                    port:py27-nose \
                    port:py27-pandas \
                    port:py27-protobuf \
                    port:py27-gflags \
                    port:py27-leveldb \
                    port:py27-dateutil

    build.target-append  pycaffe

    post-destroot {
        set packages_dir \
            ${destroot}${frameworks_dir}/Python.framework/Versions/2.7/lib/python2.7/site-packages
        xinstall -m 755 -d ${packages_dir}
        copy ${worksrcpath}/python/caffe ${packages_dir}
    }
}

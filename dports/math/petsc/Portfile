# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           bitbucket 1.0
PortGroup           mpi 1.0

bitbucket.setup     petsc petsc 3.5.2 v
revision            1
categories          math science
maintainers         sean
license             BSD
description         Portable, Extensible Toolkit for Scientific Computation
long_description    PETSc, pronounced PET-see (the S is silent), is a suite \
                    of data structures and routines for the scalable (parallel) solution \
                    of scientific applications modeled by partial differential equations. \
                    It employs the MPI standard for all message-passing communication.

platforms           darwin
universal_variant   no

checksums           rmd160  0ef78970eafb300aa8633d32748132db24fea963 \
                    sha256  a02a7b0cd388558c6a4ba78ab7d4e1c6e1c3bcd6586c42933a270da700508df4

mpi.setup

use_parallel_build  no

depends_build-append \
                    port:sowing \
                    port:c2html \
                    port:hwloc

patchfiles-append   patch-env.diff

pre-configure {
    configure.args-append \
        CC="${configure.cc}" \
        CXX="${configure.cxx}" \
        FC="${configure.fc}" \
        COPTFLAGS="${configure.optflags}" \
        CXXOPTFLAGS="${configure.optflags}" \
        FOPTFLAGS="${configure.optflags}" \
        LDFLAGS="${configure.ldflags}" \
        CFLAGS="${configure.cflags} ${configure.cc_archflags}" \
        CXXFLAGS="${configure.cxxflags}"

    if {[mpi_variant_isset]} {
        configure.args-delete --with-mpi=0 \
                              --with-fc=0
        configure.args-append --with-mpiexec=${mpi.exec}
    } elseif {[fortran_variant_isset]} {
        configure.args-delete --with-fc=0
    }

}

subport petsc-devel {
    bitbucket.setup     petsc petsc 67b4f245bc74
    bitbucket.livecheck master
    version             3.5.99
    revision            5
    name                petsc-devel

    checksums           rmd160  dabce9083c88f315cbc4e933f536ac2534c5208f \
                        sha256  c1ad8b1cb6aa2a7aadb6665c88b7ae9a918e7417d2ba16832d3e53a406ce21b9
}

notes               "Add the following line to your .bash_profile if you plan to use\
                    the PETSC makefile rules in $prefix/lib/petsc/conf: \n\
                    \texport PETSC_DIR=${prefix}/lib/${name}"

configure.args      --prefix=${prefix}/lib/${name} \
                    --with-valgrind=0 \
                    --with-mpi=0 \
                    --with-fc=0 \
                    --with-shared-libraries \
                    --with-c2html-dir=${prefix} \
                    --without-x \
                    --with-hwloc-dir=${prefix}

variant accelerate description {Use Accelerate framework for LAPACK} conflicts atlas {
    configure.args-append --with-blas-lapack-lib=/System/Library/Frameworks/Accelerate.framework/Versions/Current/Accelerate
}

variant atlas description {Use Atlas for LAPACK} conflicts accelerate {
    configure.args-append --with-blas-lapack-lib=${prefix}/lib/libtatlas.dylib
}

variant complex description {Build with support for complex numbers} conflicts sundials {
    configure.args-append --with-scalar-type=complex
    configure.args-append --with-clanguage=C++
}

variant suitesparse description {Build with CHOLDMOD and UMFPACK} {
    depends_lib-append    port:SuiteSparse
    configure.args-append --with-suitesparse-dir=${prefix}
}

variant sundials description {Build with CVODE interface for TS} {
    depends_lib-append    port:sundials
    configure.args-append --with-sundials-dir=${prefix}
    mpi.enforce_variant   sundials
}

variant superlu description {Build with SuperLU interface for a serial direct solver} {
    depends_lib-append    port:superlu
    configure.args-append --with-superlu-dir=${prefix}
}

variant mumps description {Build with MUMPS interface for a parallel direct solver} requires parmetis {
    depends_lib-append    port:mumps
    configure.args-append --with-scalapack-dir=${prefix} \
                          --with-mumps-dir=${prefix}
    mpi.enforce_variant   mumps
}

variant superlu_dist description {Build with SuperLU_DIST interface for a parallel direct solver} requires parmetis {
    depends_lib-append    port:superlu_dist
    configure.args-append --with-superlu_dist-dir=${prefix}
    mpi.enforce_variant   superlu_dist
}

variant ml description {Build with ML interface for a sparse parallel solver} {
    depends_lib-append    port:ml
    configure.args-append --with-ml-dir=${prefix}
    mpi.enforce_variant   ml
}

variant hypre description {Build with HYPRE interface for a sparse parallel solver} {
    depends_lib-append    port:hypre
    configure.args-append --with-hypre-dir=${prefix}
    mpi.enforce_variant   hypre
}

variant parmetis description {Build with ParMetis interface for parallel graph partitioning} {
    depends_lib-append    port:metis \
                          port:parmetis
    configure.args-append --with-metis-dir=${prefix} \
                          --with-parmetis-dir=${prefix}
    mpi.enforce_variant   parmetis
}

variant hdf5 description {Build with HDF5 interface for parallel file io} {
    depends_lib-append    port:hdf5
    configure.args-append --with-hdf5-dir=${prefix}

    mpi.enforce_variant   hdf5
}

variant netcdf description {Build with NetCDF interface for parallel file io} {
    depends_lib-append    port:netcdf
    configure.args-append --with-netcdf-dir=${prefix}
    mpi.enforce_variant   netcdf
}

variant fftw description {Build with FFTW interface (requires MPI)} {
    depends_lib-append    port:fftw-3
    configure.args-append --with-fftw-dir=${prefix}
    mpi.enforce_variant   fftw-3
}

variant yaml description {Build with YAML interface for option reading} {
    depends_lib-append    port:libyaml
    configure.args-append --with-yaml-dir=${prefix}
}

variant valgrind description {Build with valgrind support} {
    depends_lib-append    port:valgrind
    configure.args-delete --with-valgrind=0
    configure.args-append --with-valgrind-dir=${prefix}
}

variant debug description {Build with debug support} {
    configure.args-delete --with-debugging=0
    configure.args-append --with-debugging=1
}

if {![mpi_variant_isset]} {
    default_variants +mpich
}

if {![variant_isset atlas]} {
    default_variants +accelerate
}

destroot.destdir    DESTDIR=${destroot}${prefix}/lib/${name}

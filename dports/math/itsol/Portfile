# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           muniversal 1.0
PortGroup           compilers 1.0

name                itsol
version             2.0.0

license             GPL-2+
categories          math
platforms           darwin
maintainers         michaelld openmaintainer

description         ITerative SOLvers for sparse linear systems.

long_description    ITSOL is a library of iterative solvers for general sparse linear systems of equations. \
                    ITSOL can be viewed as an extension of the itsol module in SPARSKIT. It is written in C \
                    and offers a selection of recently developed preconditioners. The preconditioner suite includes: \
                    ILUK (ILU preconditioner with level of fill),  \
                    ILUT (ILU preconditioner with threshold), \
                    ILUC (Crout version of ILUT), \
                    VBILUK (variable block preconditioner with level of fill - with automatic block detection), \
                    VBILUT (variable block preconditioner with threshold - with automatic block detection), \
                    ARMS (Algebraic Recursive Multilevel Solvers -- includes actually several methods, \
                    in particular the standard ARMS and the ddPQ version which uses nonsymmetric permutations). \
                    Note that ITSOL is a scalar package.

homepage            http://www-users.cs.umn.edu/~saad/software/ITSOL/

set distname        ITSOL_2
master_sites        http://www-users.cs.umn.edu/~saad/software/ITSOL/
checksums           rmd160 fe61d6602df541a30e0f3b587ac123bd6f1d318e \
                    sha256 de8f2726e2dbc248e8ccebdbc9ce8515ad47a8c8595cca87264c22b44845736a

patchfiles          patch-INC_protos.h.diff \
                    patch-SRC.diff \
                    patch-makefile.diff \
                    patch-TESTS-matfile.diff

compilers.choose    fc
compilers.setup     require_fortran

# atlas does not provide a +g95 variant, so if +g95 is used,
# +accelerate must also be used.  +accelerate will work with +gccXY,
# so this is all a bit complex to check for.  Setting 'requires' here
# does not yet seem to work with 'port' to get [+]accelerate; leaving
# it out does work, so doing that and checking for this condition
# later, for now.

######################
# set up BLAS variants

# atlas does not work with g95, so always conflict with it

variant atlas description {use BLAS from MacPorts' atlas port} \
    conflicts g95 accelerate {}

# accelerate works with any fortran variant

variant accelerate description \
    {use BLAS from Apple's Accelerate.framework [might be buggy]} \
    conflicts atlas {}

##################
# variant checking

# check for BLAS default variant, use +atlas if nothing else

set blas_variant_selection ""
if {[variant_isset g95] || [variant_isset accelerate]} {
    set blas_variant_selection "accelerate"
} else {
    set blas_variant_selection "atlas"
}

default_variants +${blas_variant_selection}

# make sure that either +accelerate or +atlas is selected

if {![variant_isset accelerate] && ![variant_isset atlas]} {
    ui_error "\n\nYou cannot use the -${blas_variant_selection} variant alone; you must select either the +accelerate or +atlas variant.\n"
    return -code error "Invalid variant selection"
}

#######################
# figure out BLAS flags

if {[variant_isset accelerate]} {

    configure.ldflags-append -Wl,-framework -Wl,Accelerate

} else {

    depends_lib-append       port:atlas
    configure.ldflags-append -llapack -lcblas -lf77blas -latlas

}

##########################
# configure MacPorts build

use_configure        yes
configure.cmd        make
configure.pre_args   lib
configure.env-append PREFIX=${prefix}
configure.universal_args
destroot.env-append  PREFIX=${prefix}

pre-fetch {

    # check for +accelerate.  Apple's VecLib has bugs that can cause
    # crashes, while Atlas does not have these issues.  Print a
    # warning if this variant is in use, but do not force the use of
    # +atlas (for now).

    if {[variant_isset accelerate]} {
        ui_msg "\nWARNING: The +accelerate variant has been selected, using Apple's Vector Libraries which have known bugs that can cause crashes.  The +atlas variant does not have these issues, and is generally considered a better way to go.\n"
    }
}

test.run       yes
pre-test {
    test.args-append     LINKS="-L../LIB -litsol" \
        FC="${configure.fc}" FCFLAGS="${configure.fcflags}" \
        CC="${configure.cc}" CCFLAGS="-c -I ../INC ${configure.cflags} -DLINUX" \
        LD="${configure.fc}" LDFLAGS="${configure.ldflags}"
}

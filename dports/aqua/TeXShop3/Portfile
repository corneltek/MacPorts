# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem      1.0
PortGroup       xcode 1.0

name            TeXShop3
conflicts	TeXShop
version         3.39

set major       [lindex [split ${version} .] 0]
categories      aqua editors
license         GPL-2+
maintainers     jwa openmaintainer
description     TeX previewer for Mac OS X
long_description   \
    TeXShop is a TeX previewer for Mac OS X, written in Cocoa.  \
    Since pdf is a native file format on OS X, TeXShop uses     \
    "pdftex" and "pdflatex" rather than "tex" and "latex" to    \
    typeset, these programs in the standard teTeX distribution  \
    of TeX produce pdf output instead of dvi output.
homepage        http://pages.uoregon.edu/koch/texshop
master_sites    ${homepage}/texshop-64
use_zip         yes
distname        texshopsource${version}
dist_subdir     TeXShop/
worksrcdir      texshopsource-${version}
#worksrcdir      texshopsource[strsed ${version} {/\.//}]
set propername	TeXShop

checksums           rmd160  c3603ff2e9eb5f30b5228aa09617b14529ecb4be \
                    sha256  45b4d32114dbd204cb69f3d460dafbc61144794f22c3608a39bc67eb09fa898f

pre-fetch {
    platform darwin {
        if {${os.major} < 11} {
            ui_error "${name} requires at least 10.7, Lion"
            return -code error	"This version is for 10.7, Lion, and later only"
        }
    }
}

post-extract    {
    set sparkle "Sparkle.framework/Versions/A/Sparkle"
    set ogrekit "OgreKit.framework/Versions/A/OgreKit"
    if {![variant_isset universal]} {
        # thin the bundled frameworks
        system "cd ${worksrcpath} && lipo -thin ${configure.build_arch} $sparkle -output $sparkle"
        system "cd ${worksrcpath} && lipo -thin ${configure.build_arch} $ogrekit -output $ogrekit"
    }
}

macosx_deployment_target     10.7

build.target    ${propername}
build.pre_args-append   -sdk macosx10.8
destroot.pre_args-append    -sdk macosx10.8

platform darwin 13 {
build.pre_args-delete   -sdk macosx10.8
destroot.pre_args-delete    -sdk macosx10.8
build.pre_args-append   -sdk macosx10.9
destroot.pre_args-append    -sdk macosx10.9
}

xcode.project   ${propername}.xcodeproj
xcode.configuration Release
xcode.build.settings    FRAMEWORK_SEARCH_PATHS=${worksrcpath} \
                        CONFIGURATION_BUILD_DIR=${worksrcpath}/build

destroot.target     ${propername}
eval xcode.destroot.settings INSTALL_MODE_FLAG=755 ${xcode.build.settings}

post-destroot        {
    file delete -force ${destroot}${applications_dir}/TeX.mdimporter
}

livecheck.type      regex
livecheck.regex     TeXShop \\(v (${major}\.\[0-9.\]+)\\)

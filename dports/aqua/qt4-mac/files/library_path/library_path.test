#!/bin/sh

LIBRARY_PATH_SUPPORT=no
COMPILER=$1
VERBOSE=$2
WORKDIR=$3

cd $3

# (1) make the library
if "$COMPILER" -dynamiclib -o library_path_lib.dylib library_path_lib.c 2>/dev/null 1>&2; then
    # (2) do the test, without LIBRARY_PATH; should fail
    if "$COMPILER" -nostdlib -nostdinc -I. -o library_path_test library_path_test.c -lrary_path_lib 2>/dev/null 1>&2; then
	true
    else
	# (3) do the test, with LIBRARY_PATH set; should pass
	export LIBRARY_PATH=.
	if "$COMPILER" -nostdlib -nostdinc -I. -o library_path_test library_path_test.c -lrary_path_lib 2>/dev/null 1>&2; then
	    LIBRARY_PATH_SUPPORT=yes
	fi
    fi
    rm -f library_path_test.o library_path_test
else
    echo "Unable to compile library; assuming LIBRARY_PATH works"
    exit 1
fi
rm -f library_path_lib.dylib library_path_lib.o

if [ "$LIBRARY_PATH_SUPPORT" != "yes" ]; then
    [ "$VERBOSE" = "yes" ] && echo "LIBRARY_PATH support not detected"
    exit 0
else
    [ "$VERBOSE" = "yes" ] && echo "LIBRARY_PATH support detected"
    exit 1
fi

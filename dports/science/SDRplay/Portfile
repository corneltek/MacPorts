# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                SDRplay
maintainers         michaelld openmaintainer

description         ${name} provides support for SDRplay hardware

categories          science comms
homepage            http://sdrplay.com/
license             restrictive/distributable
platforms           darwin macosx

version             1.95.2
checksums \
    rmd160 d305b2de0677cef7cca27b343ccf7bcd8cb979e4 \
    sha256 1189afd32389034c5ff43d3db3554c5aba63b7740415bb02beba95fd3b497829

global sdrplay_lib
set sdrplay_lib "libmirsdrapi-rsp.dylib"
global SDRplay_Distfile
set SDRplay_Distfile "SDRplay_RSP_API_Installer_${version}.pkg"

distfiles ${SDRplay_Distfile}

master_sites http://www.sdrplay.com/software/

depends_lib-append path:lib/libusb-1.0.dylib:libusb

extract {

    # extract the PKGs we need here
    global SDRplay_Distfile
    system "mkdir ${worksrcpath}"
    system -W ${worksrcpath} "pkgutil --expand ${distpath}/${SDRplay_Distfile} pkg"
    system -W ${worksrcpath} "mkdir sdrplay"
    system -W ${worksrcpath}/sdrplay "mv ../pkg/libmirsdrapi*.pkg/Payload tmp0.tar.gz && /usr/bin/gzip -dc tmp0.tar.gz | /usr/bin/tar -xf -"
    system -W ${worksrcpath}/sdrplay "mv ../pkg/mirsdrapirsp.pkg/Payload tmp1.tar.gz && /usr/bin/gzip -dc tmp1.tar.gz | /usr/bin/tar -xf -"

}

configure {}

build {

    # fix SDRPlay library to work with MacPorts
    global sdrplay_lib
    system -W ${worksrcpath}/sdrplay "mv libmirsdrapi-rsp* ${sdrplay_lib}"
    system -W ${worksrcpath}/sdrplay "install_name_tool -id ${prefix}/lib/libmirsdrapi-rsp.dylib ${sdrplay_lib}"
    system -W ${worksrcpath}/sdrplay "install_name_tool -change /usr/local/lib/libusb-1.0.0.dylib ${prefix}/lib/libusb-1.0.0.dylib ${sdrplay_lib}"

}

destroot {

    # install sdrplay
    global sdrplay_lib
    set sdrplay_dir "${worksrcpath}/sdrplay"
    copy ${sdrplay_dir}/${sdrplay_lib} ${destroot}${prefix}/lib
    copy ${sdrplay_dir}/mirsdrapi-rsp.h ${destroot}${prefix}/include

}

livecheck.url       http://sdrplay.com/mac.html
livecheck.regex     Current API Installer: (\[0-9.\]+)

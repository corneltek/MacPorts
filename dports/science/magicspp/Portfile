# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup cmake     1.0
PortGroup compilers 1.0

compilers.choose    fc
compilers.setup     require_fortran -g95

name                magicspp
version             2.22.6
platforms           darwin
maintainers         takeshi
license             Apache-2
categories          science
description         ECMWF's Meteorological plotting software
homepage            http://software.ecmwf.int/wiki/display/MAGP/Magics
master_sites        https://software.ecmwf.int/wiki/download/attachments/3473464/
distname            Magics-${version}-Source
checksums           md5     99ac8a9b50861f4632ca3b96099dc14b \
                    sha1    c61311413c396f74f04eecda3b51293cdfd9df48 \
                    rmd160  847e8a16fcf17c83410e82bdfe99dafc62d85c08
long_description \
    Magics++ is the latest generation of the ECMWF's Meteorological plotting \
    software MAGICS (Meteorological Applications Graphics Integrated Colour System) \
    redesigned in C++.  Magics++ offers interfaces in Fortran, C, and MagML, \
    a plot description language based on XML.  The library supports the plotting of \
    contours, wind fields, observations, satellite images, symbols, text, axis \
    and graphs (including boxplots). Input data can be in GRIB 1 and 2, BUFR and NetCDF \
    or retrieved from an ODB database. The produced meteorological plots can be saved \
    in various formats, such as PostScript, EPS, PDF, GIF, PNG and SVG.

fetch.ignore_sslcert    yes

depends_build       port:cmake \
                    port:flex
depends_lib         port:emos \
                    port:grib_api \
                    port:netcdf-cxx \
                    port:mesa \
                    port:xorg-libXau \
                    port:xorg-libXdmcp \
                    port:p5.12-xml-parser \
                    port:gd2 \
                    path:lib/pkgconfig/pango.pc:pango \
                    port:ghostscript \
                    port:boost \
                    port:proj47 \
                    port:swig-python
require_active_variants cairo x11

use_parallel_build  no
universal_variant   no

if {![fortran_variant_isset]} {
    default_variants-append +gcc48
}
if {![variant_isset python25] && ![variant_isset python26]} {
    default_variants-append +python27
}

configure.cmd           cmake
configure.dir           ${workpath}/build
configure.args-append   -DBOOST_ROOT=${prefix} \
                        -DCMAKE_Fortran_COMPILER=${configure.fc} \
                        -DENABLE_BUFR=ON \
                        -DENABLE_CAIRO=ON \
                        -DENABLE_FORTRAN=OFF \
                        -DENABLE_GRIB=ON \
                        -DENABLE_LARGE_FILE_SUPPORT=ON \
                        -DENABLE_NETCDF=ON \
                        -DENABLE_PYTHON=ON \
                        -DEXPAT_INCLUDE_DIR=${prefix}/include \
                        -DEXPAT_LIBRARY=${prefix}/lib/libexpat.dylib \
                        -DFLEX_EXECUTABLE=${prefix}/bin/flex \
                        -DFLEX_INCLUDE_DIR=${prefix}/include \
                        -DFL_LIBRARY=${prefix}/lib/libfl.a \
                        -DGRIB_API_PATH=${prefix} \
                        -DGRIB_API_INCLUDE_DIR=${prefix}/include \
                        -DGRIB_API_INFO=${prefix}/bin/grib_info \
                        -DGRIB_API_JPG=ON \
                        -DGRIB_API_LIBRARY=${prefix}/lib/libgrib_api.dylib \
                        -DGRIB_API_PNG=ON \
                        -DGS_LIBRARIES=${prefix}/lib/libgs.dylib \
                        -DHDF5_CXX_COMPILER_EXECUTABLE=${prefix}/bin/h5c++ \
                        -DHDF5_CXX_INCLUDE_DIR=${prefix}/include \
                        -DHDF5_C_COMPILER_EXECUTABLE=${prefix}/bin/h5cc \
                        -DHDF5_C_INCLUDE_DIR=${prefix}/include \
                        -DHDF5_DIFF_EXECUTABLE=${prefix}/bin/h5diff \
                        -DHDF5_hdf5_cpp_LIBRARY_RELEASE=${prefix}/lib/libhdf5.dylib \
                        -DHDF5_hdf5_hl_LIBRARY_RELEASE=${prefix}/lib/libhdf5_hl.dylib \
                        -DJASPER_INCLUDE_DIR=${prefix}/include \
                        -DJASPER_LIBRARY_RELEASE=${prefix}/lib/libjasper.dylib \
                        -DJPEG_INCLUDE_DIR=${prefix}/include \
                        -DJPEG_LIBRARY=${prefix}/lib/libjpeg.dylib \
                        -DNETCDF_CONFIG_EXECUTABLE=${prefix}/bin/nc-config \
                        -DNETCDF_netcdf.h_INCLUDE_DIR=${prefix}/include \
                        -DNETCDF_netcdf_LIBRARY_RELEASE=${prefix}/lib/libnetcdf.dylib \
                        -DNETCDF_netcdf_c++_LIBRARY_RELEASE=${prefix}/lib/libnetcdf_c++.dylib \
                        -DNETCDF_netcdfcpp.h_INCLUDE_DIR=${prefix}/include \
                        -DOPENJPEG_INCLUDE_DIR=${prefix}/include \
                        -DOPENJPEG_LIBRARY=${prefix}/lib/libopenjpeg.dylib \
                        -DPERL_EXECUTABLE=${prefix}/bin/perl \
                        -DPKG_CONFIG_EXECUTABLE=${prefix}/bin/pkg-config \
                        -DPNG_LIBRARY_RELEASE=${prefix}/lib/libpng.dylib \
                        -DPNG_PNG_INCLUDE_DIR=${prefix}/include \
                        -DPROJ4_INCLUDE_DIR=${prefix}/include \
                        -DPROJ4_LIBRARY=${prefix}/lib/libproj.dylib \
                        -DSWIG_EXECUTABLE=${prefix}/bin/swig \
                        -DZLIB_INCLUDE_DIR=${prefix}/include \
                        -DZLIB_LIBRARY=${prefix}/lib/libz.dylib
configure.post_args     ../${distname}
post-configure {
    reinplace "s|Magics-${version}-Source/python/Magics/Magics.i$|build/python/Magics/Magics.i|g" ${workpath}/build/python/Magics/CMakeFiles/_Magics.dir/build.make
    reinplace "s|-lcairo|-lcairo -lX11|" ${workpath}/build/src/CMakeFiles/MagPlusShared.dir/link.txt
    foreach d {bufr grib} {
        reinplace "s|${configure.fc}|${configure.cxx}|" ${workpath}/build/test/CMakeFiles/${d}_fortran.dir/link.txt
    reinplace "s|-I/opt/local/include||g" ${workpath}/build/src/magics.pc
    }
}

build.dir               ${workpath}/build

post-destroot {
    file rename ${destroot}${prefix}/share/templates ${destroot}${prefix}/share/magics
    if {[variant_isset python25] || [variant_isset python26] || [variant_isset python27]} {
        file mkdir ${destroot}${frameworks_dir}/Python.framework/Versions/${pyver}/lib/python${pyver}/site-packages
        file rename ${destroot}${prefix}/lib/python${pyver}/site-packages/Magics ${destroot}${frameworks_dir}/Python.framework/Versions/${pyver}/lib/python${pyver}/site-packages
    }
}

if {[fortran_variant_isset]} {
    configure.args-delete   -DENABLE_FORTRAN=OFF
    configure.args-append   -DGFORTRAN_EXECUTABLE=${configure.fc} \
                            -DGFORTRAN_LIB=${prefix}/lib/[fortran_variant_name]/libgfortran.dylib
}

if {[variant_isset python25]} {
    set pyver 2.5
}
if {[variant_isset python26]} {
    set pyver 2.6
}
if {[variant_isset python27]} {
    set pyver 2.7
}
if {[variant_isset python25] || [variant_isset python26] || [variant_isset python27]} {
    configure.args-delete   -DENABLE_PYTHON=OFF
    configure.args-append   -DENABLE_PYTHON=ON
    configure.args-append   -DPYTHON_EXECUTABLE=${prefix}/bin/python${pyver} \
                            -DPYTHON_CONFIG=${prefix}/bin/python${pyver}-config
}

variant python25 description {Add support for python25} {
    depends_lib-append      port:py25-numpy
}

variant python26 description {Add support for python26} {
    depends_lib-append      port:py26-numpy
}

variant python27 description {Add support for python27} {
    depends_lib-append      port:py27-numpy
}

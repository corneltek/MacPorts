# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           github 1.0

name                gqrx
maintainers         michaelld openmaintainer

description         Gqrx is a software defined radio (SDR) receiver using GNU Radio, OSMOSDR, and Qt (4 or 5).
long_description {Gqrx is a software defined radio receiver for Funcube Dongle (FCD), RTL2832U-based DVB-T devices (RTL-SDR), Universal Software Radio Peripherals (USRP) and Osmo SDR devices.  Gqrx is powered by GNU Radio and the Qt GUI toolkit.  Gqrx is free and open source software and anyone is invited to hack the source code to suit their needs.}

categories          science comms
license             GPL-3 BSD
platforms           darwin macosx

# common directory for storing downloaded tarballs
dist_subdir         gqrx

if {${subport} eq ${name}} {

    github.setup    csete gqrx 2.5.1 v   
    checksums       \
        rmd160 0bfa0aa6a9e1d1348daf0cbf7e4f87faafd2c8cc \
        sha256 2214f2631b91f2c307ccab3c7d55b694fe1cd8a941dc8271bcf38234ab60fb05

    patchfiles-append   patch-gqrx.pro.release.diff

    # bump the epoch because I moved the version from 20160113 to 2.5.1
    epoch           1

    long_description ${long_description} ${subport} \
provides the release version, which is typically updated every month or so.
    conflicts       gqrx-devel

}

subport gqrx-devel {

    github.setup        csete gqrx 7e4a45a7e160b80b4dfefa2a705ebcdfd4fad295
    version             20160113
    checksums           rmd160 6d5673644b29c62d767c8cb51c1374b1498e18f9 \
                        sha256 1125c339a264606953b33f5c8984f5ec44cf6f82ba7523952a8fc2ee06cea64f

    patchfiles-append   patch-gqrx.pro.devel.diff

    long_description    ${long_description}  \
        This port is kept up with the Gqrx GIT 'master' branch, is typically updated weekly to monthly, and provides compatibility with the GNU Radio release 3.7 API: the gnuradio and gnuradio-devel ports.
    conflicts           gqrx

}

# allow gqrx to work with both gnuradio and gnuradio-devel ...

depends_lib-append  port:gr-osmosdr \
    path:lib/libgnuradio-audio.dylib:gnuradio

# ... but not with gnuradio-next

pre-fetch {
    if {![catch {set installed [lindex [registry_active gnuradio-next] 0]}]} {
        # gnuradio-next is installed; this version of gr-osmosdr does not work with gnuradio-next
        ui_msg "\nError: ${name} requires the gnuradio or gnuradio-devel port, and will not work with the gnuradio-next port.  deactivate gnuradio-next, and then install or activate gnuradio or gnuradio-devel.\n"
        return -code error "Invalid port dependency: gnuradio-next"
    }
}

# override githib PortGroup homepage setting

homepage            http://gqrx.dk/

variant qt4 conflicts qt5 description {Build ${subport} using Qt4} {
    PortGroup qmake 1.0
}

variant qt5 conflicts qt4 description {Build ${subport} using Qt5} {

    PortGroup qmake5 1.0
    PortGroup active_variants 1.1

    # make sure gnuradio* is installed with -qtgui, because we
    # can't have Qt4 and Qt5 installed at the same time (yet),
    # and gnuradio* does not (yet) support Qt5.

    require_active_variants path:lib/libgnuradio-audio.dylib:gnuradio "" qtgui

}

# default to +qt4

if {![variant_isset qt4] && ![variant_isset qt5]} {
    default_variants +qt4
}

# make sure -qt4 is not used alone

if {![variant_isset qt4] && ![variant_isset qt5]} {

    ui_error "\n\nYou must select either the +qt4 or +qt5 variant.\n"
    return -code error "Invalid variant selection"

}

post-patch {

    # set install location

    reinplace "s|@APPSDIR@|${qt_apps_dir}|g" ${worksrcpath}/gqrx.pro

    # set version

    reinplace "s|@VERSION@|${version}|g" ${worksrcpath}/gqrx.pro

    # set arch type(s)

    reinplace "s|@ARCHES@|${qt_arch_types}|g" ${worksrcpath}/gqrx.pro

}

configure.post_args gqrx.pro

post-configure {

    # remove indirect dependency on Volk added by pkgconfig

    reinplace "s|-lvolk ||g" ${worksrcpath}/Makefile

}

post-destroot {

    # link the executable back to $qt_bins_dir, and, if $qt_dir is
    # not $prefix, back to $prefix/bin too.

    xinstall -m 755 -d ${destroot}${qt_bins_dir}
    ln -s ${qt_apps_dir}/Gqrx.app/Contents/MacOS/Gqrx \
        ${destroot}${qt_bins_dir}

    if {${qt_dir} ne ${prefix}} {
        xinstall -m 755 -d ${destroot}${prefix}/bin
        ln -s ${qt_apps_dir}/Gqrx.app/Contents/MacOS/Gqrx \
            ${destroot}${prefix}/bin
    }
}

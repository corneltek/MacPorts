# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                apache-solr
version             3.5.0
categories          java textproc
platforms           darwin
maintainers         gmail.com:haya10.ito hum openmaintainer
license             Apache-2.0

homepage            http://lucene.apache.org/solr/
description         An open source enterprise search platform.
long_description    Solr is the popular, blazing fast open source enterprise \
                    search platform from the Apache Lucene project.

master_sites        apache:lucene/solr/${version}/
extract.suffix      .tgz
checksums           rmd160  365d4b27753375ea3a39b9d42c06b80dce474731 \
                    sha256  804f3ba9d1296f81388605a79538b7362355693fbdd03b7b2dbf9a706bf1d1d0

# set the destination paths.
set java_basepath   ${prefix}/share/java
set solr_destpath   ${java_basepath}/${distname}
set solr_path       ${solr_destpath}/example
set solr_home       ${solr_path}/solr

post-patch {
    # expand relative pathes into abusolute ones.
    reinplace "s|\"\\.\\./\\.\\./|\"${solr_destpath}/|g" \
        ${worksrcpath}/example/solr/conf/solrconfig.xml
}

use_configure       no
supported_archs     noarch

build {}

destroot {
    # copy the distribution.
    xinstall -d         ${destroot}${java_basepath}
    copy ${worksrcpath} ${destroot}${java_basepath}
    # install the solr script.
    xinstall -m 755 ${filespath}/solr.in     ${destroot}${prefix}/bin/solr
    reinplace "s|@solr_path@|${solr_path}|g" ${destroot}${prefix}/bin/solr
    reinplace "s|@solr_home@|${solr_home}|g" ${destroot}${prefix}/bin/solr
}

notes "
To try apache-solr, run 'sudo solr' and open http://localhost:8983/solr/browse.
To store sample documents, run 'cd ${solr_path}/exampledocs && ./post.sh *.xml'."

# solr home for Japanese configurations.
set solr_home_ja    ${solr_home}-ja

variant ja description {Add Japanese settings with lucene-gosen} {
    depends_run-append  port:lucene-gosen
    # create Japanese solr home 'solr-ja'.
    post-extract {
        copy ${worksrcpath}/example/solr ${worksrcpath}/example/solr-ja
    }
    patchfiles-append   patch-solr-ja.diff
    post-patch {
        # expand relative pathes into abusolute ones.
        reinplace "s|\"\\.\\./\\.\\./|\"${solr_destpath}/|g" \
            ${worksrcpath}/example/solr-ja/conf/solrconfig.xml
    }
    post-destroot {
        # set the lucene-gosen configuration path to config files.
        foreach config {schema.xml solrconfig.xml} {
            reinplace "s|@gosen_path@|${java_basepath}/lucene-gosen|g" \
                ${destroot}${solr_home_ja}/conf/${config}
        }
        # install a property file for UTF-8 encoding.
        copy ${filespath}/velocity.properties ${destroot}${solr_home_ja}/conf
        # copy a sample Japanese doc for testing.
        copy ${filespath}/solr-ja.xml ${destroot}${solr_path}/exampledocs
        # install the solr-ja script.
        xinstall -m 755 ${filespath}/solr.in        ${destroot}${prefix}/bin/solr-ja
        reinplace "s|@solr_path@|${solr_path}|g"    ${destroot}${prefix}/bin/solr-ja
        reinplace "s|@solr_home@|${solr_home_ja}|g" ${destroot}${prefix}/bin/solr-ja
    }
    notes-append "

For Japanese texts, please run 'sudo solr-ja' instead of 'sudo solr'.
See ${solr_home_ja}."
}

livecheck.type      regex
livecheck.url       http://www.apache.org/dist/lucene/solr/
livecheck.regex     (\[0-9.\]+)\/

# -*- coding: utf-8; mode: tcl; tab-width: 4; c-basic-offset: 4 -*-
# $Id$

PortSystem          1.0
PortGroup           python 1.0
PortGroup           active_variants 1.1

set realname        graph-tool
name                py-${realname}
version             2.2.25
categories          python science
platforms           darwin
license             GPL-3
maintainers         skewed.de:tiago mmoll
description         Efficient python graph module
long_description    graph-tool is an efficient python module for manipulation \
                    and statistical analysis of graphs. The internal data \
                    structures and most algorithms are implemented in C++ with \
                    the Boost Graph Library.
homepage            http://graph-tool.skewed.de
master_sites        http://downloads.skewed.de/graph-tool/
use_bzip2           yes
checksums           md5     83a7c55ac58eb2ef67f0c16ecb36b711 \
                    sha1    3b740243662a4dd4e5a1f7aa20f4ddf6fab1ea31 \
                    rmd160  5bf4f9e42142c4ee9a10b825bcfaeed548a396ac
distname            ${realname}-${version}
python.versions     26 27 32 33
python.default_version 27

if {$subport != $name} {
    universal_variant  no
    depends_build-append port:pkgconfig
    depends_lib-append port:boost \
                       port:cairomm \
                       port:cgal \
                       port:expat \
                       path:bin/dot:graphviz \
                       port:py${python.version}-numpy \
                       port:py${python.version}-scipy \
                       port:py${python.version}-gobject3 \
                       port:py${python.version}-cairo
    use_configure      yes
    # parallel build starts swapping, even on a MacBook Pro with 8GB of RAM.
    use_parallel_build no

    # graph-tool relies on Boost.Python, so make sure it is installed.
    require_active_variants boost python${python.version}

    # PYTHON_EXTRA_LDFLAGS is set to work around incorrect detection of
    # link flags by configure
    configure.env-append PYTHON=${python.bin} \
                         PYTHON_VERSION=${python.branch} \
                         PYTHON_CPPFLAGS=-I${python.include} \
                         PYTHON_LDFLAGS="-L${python.libdir}/.. -lpython${python.branch}" \
                         PYTHON_EXTRA_LDFLAGS="-L${python.libdir}/.. -lpython${python.branch}"
    configure.cppflags-append -I${prefix}/include -I${python.include}/..
    configure.ldflags-append -L${prefix}/lib
    configure.args-append --with-boost=${prefix} --exec-prefix=${python.prefix}
    # Clang uses the old libstc++ from gcc 4.2 by default. Boost doesn't
    # include some of the tr1 headers in libstdc++ and defines its own tr1
    # classes. This causes conflicts with sparsehash which insists on using
    # the old tr1 headers. Remove this if/when clang switches to libc++ at
    # some point.
    if {[string match *clang* ${configure.compiler}]} {
        configure.args-append --disable-sparsehash
        # http://graph-tool.skewed.de/ticket/141
        patchfiles-append patch-clang.diff
    } else {
        depends_lib-append port:sparsehash
        configure.cppflags-append -I${prefix}/include/sparsehash
    }
    build.cmd          make
    build.target       all
    destroot.cmd       make
    destroot.destdir   DESTDIR=${destroot}

    post-destroot {
        file rename ${destroot}${prefix}/share/doc/graph-tool \
            ${destroot}${prefix}/share/doc/py${python.version}-graph-tool
    }
}

if {$name == $subport} {
    livecheck.type      regex
    livecheck.url       $homepage
    livecheck.regex     Download version (\[0-9.\]+)
} else {
    livecheck.type      none
}

# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           conflicts_build 1.0
PortGroup           compiler_blacklist_versions 1.0

name                audacious-core
set real_name       audacious

# Please keep audacious, audacious-core and audacious-plugins synchronized.
version             3.6.1
revision            1

license             BSD
categories          multimedia
platforms           darwin
maintainers         ionic
homepage            http://www.audacious-media-player.org/
description         Audacious is an advanced audio player.
long_description    ${description} It is free, lightweight, based on GTK3, \
                    runs on Linux and many other *nix platforms. The player focuses on audio quality \
                    and supports a wide range of audio codecs. \
                    Its advanced audio playback engine is considerably more powerful than GStreamer. \
                    Audacious is a fork of Beep Media Player (BMP), which itself forked from XMMS.

# Maintainer-only helper for testing changes quickly and easily.
#fetch.type          git
#git.url             git://github.com/Ionic/${real_name}
#git.branch          ${real_name}-${version}-buildfix

master_sites        http://distfiles.audacious-media-player.org
distname            ${real_name}-${version}
use_bzip2           yes
checksums           rmd160  45efb8bd90e0c0529be6c4ce82952f300b422e90 \
                    sha256  85d1d5a80240f45c858bb25af6565c13d53e4b92882eb15fb2b18511fabf3de6

universal_variant   no

conflicts_build     ${name}

patchfiles          patch-buildsys.diff \
                    patch-acinclude.m4-drop-libc++-switch-from-gnu++11-to-c++11.diff

depends_build       path:bin/pkg-config:pkgconfig \
                    path:bin/aclocal:automake \
                    path:bin/autom4te:autoconf

depends_lib         port:libiconv \
                    port:gettext \
                    path:lib/pkgconfig/dbus-1.pc:dbus \
                    path:lib/pkgconfig/glib-2.0.pc:glib2

# Note: rpath is required on Mac OS X.
configure.args      --enable-nls \
                    --enable-rpath \
                    --enable-dbus \
                    --disable-chardet \
                    --disable-valgrind

use_autoreconf      yes
autoreconf.cmd      ./autogen.sh
autoreconf.args

# A compiler supporting C++11 is required to build audacious and its plugins.
# The newer, the merrier.
# Compilers supporting C++11 are GCC >= 4.6 and clang >= 3.3.
# As we only support libc++, clang is required by implicitly.
# Blacklist all GCC compilers to not accidentally pull in libstdc++.
# We do not know what "cc" is, so blacklist it as well.
compiler.blacklist-append   {*gcc*} {clang < 500} macports-clang-2.* \
                            {macports-clang-3.[0-2]} cc

platform darwin {
    pre-configure {
        if {${configure.cxx_stdlib} eq "libstdc++"} {
            ui_error "This port does not support your selected MacPorts C++ runtime. libc++ must be selected and C++-based ports built against this."
            error "libstdc++ unsupported."
        }
    }
}

post-destroot {
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${real_name}
    move ${destroot}${prefix}/share/${real_name}/AUTHORS \
         ${destroot}${prefix}/share/${real_name}/COPYING \
         ${destroot}${prefix}/share/doc/${real_name}
}

# Needs libguess, which is currently not ported.
#variant chardet description {Try to handle non-UTF8 chinese/japanese/korean ID3 tags} {
#    configure.args-replace --disable-chardet \
#                           --enable-chardet
#}

variant qt5 description {Add Qt5 support} {
    PortGroup   qt5 1.0

    configure.args-replace  --disable-qt \
                            --enable-qt

    notes-append {
                    Qt5 support is optional and untested.
                    If it breaks, you've got to keep the pieces.\
    }
}

variant gtk2 conflicts gtk3 description {Add GTK2 support} {
    depends_lib-append      path:lib/pkgconfig/gtk-2.0.pc:gtk2

    configure.args-replace  --disable-gtk \
                            --enable-gtk
}

variant gtk3 conflicts gtk2 description {Add GTK3 support} {
    depends_lib-append      path:lib/pkgconfig/gtk-3.0.pc:gtk3

    patchfiles-append       patch-gtk3.diff

    configure.args-replace  --disable-gtk \
                            --enable-gtk
}

# Need either one of gtk2 or gtk3. Default to gtk2, which is preferred by upstream.
if {![variant_isset gtk2] && ![variant_isset gtk3]} {
    default_variants-append +gtk2
}

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     "${real_name}-(\\d+(?:\\.\\d+)*)${extract.suffix}"

# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0

name                    mplayer2
categories              multimedia
platforms               darwin
license                 Restrictive
maintainers             cal openmaintainer
description             mplayer2 is an advanced general-purpose video player. A fork of the original MPlayer project, it contains significant \
                        further development and supports a number of features not available in other Unix players.
long_description        ${description}

homepage                http://www.mplayer2.org/
version                 2.0-20120517
fetch.type              git
git.url                 git://git.mplayer2.org/mplayer2-build.git
git.branch              ab6542dbc0130ff8dbede27896eb7dd925332c68

conflicts               MPlayer mplayer-devel

depends_build-append    port:pkgconfig \
                        port:yasm \
                        port:autoconf

depends_lib-append      port:xorg-libXv \
                        port:xorg-libXvMC \
                        port:freetype \
                        port:fontconfig \
                        port:libdvdnav \
                        port:libdvdread \
                        port:libdvdcss \
                        port:libcddb \
                        port:fribidi \
                        port:libpng \
                        port:libmng \
                        port:jpeg \
                        port:openjpeg \
                        port:libcdio \
                        port:libdv \
                        port:libvorbis \
                        port:libtheora \
                        port:faac \
                        port:faad2 \
                        port:a52dec \
                        path:lib/pkgconfig/sdl.pc:libsdl \
                        port:dirac \
                        port:schroedinger \
                        port:lame \
                        port:speex \
                        port:libvpx \
                        port:XviD \
                        port:x264

use_configure           no
universal_variant       no

set mplayercflags      "--disable-smb \
                        --enable-macosx-finder \
                        --disable-gif \
                        --enable-png \
                        --enable-mng \
                        --enable-jpeg \
                        --enable-libcdio \
                        --enable-xvid \
                        --enable-theora \
                        --enable-faad \
                        --enable-liba52 \
                        --enable-sdl \
                        --enable-xv \
                        --enable-corevideo \
                        --enable-cocoa \
                        --enable-coreaudio \
                        --enable-translation \
                        --language=all"

set ffmpegcflags       "--enable-libschroedinger \
                        --enable-libmp3lame \
                        --enable-libopenjpeg \
                        --enable-libspeex \
                        --enable-libtheora \
                        --enable-libvorbis \
                        --enable-libvpx \
                        --enable-libx264 \
                        --enable-libxvid \
                        --enable-libfaac \
                        --enable-nonfree"

configure.cppflags-append \
                        -I${prefix}/include/dirac \
                        -I${prefix}/include/schroedinger-1.0

post-extract {
    system -W ${worksrcpath} "./init --shallow"
}

patchfiles              no-cflags-in-cpp-libav-configure.patch

pre-build {
    set commonconf  [open "${worksrcpath}/common_options" "a"]
    set ffmpegconf  [open "${worksrcpath}/libav_options" "a"]
    set mplayerconf [open "${worksrcpath}/mplayer_options" "a"]

    puts $commonconf "--cc=${configure.cc}"
    puts $commonconf "--extra-cflags=${configure.cflags} ${configure.cppflags} [get_canonical_archflags]"
    puts $commonconf "--extra-ldflags=${configure.ldflags} [get_canonical_archflags]"

    foreach option $mplayercflags {
        puts $mplayerconf $option
    }

    foreach option $ffmpegcflags {
        puts $ffmpegconf $option
    }

    puts $mplayerconf "--extra-ldflags=-lintl -lcdio -lcdio_cdda -lcdio_paranoia -la52"
    puts $mplayerconf "--prefix=${prefix}"

    close $commonconf
    close $ffmpegconf
    close $mplayerconf

    reinplace -E "s|'--cpu=host',||" ${worksrcpath}/script/libav-config
}

build.target            mplayer
build.env-append        CC=${configure.cc} \
                        CPP=${configure.cpp} \
                        CFLAGS="${configure.optflags} [get_canonical_archflags]" \
                        CPPFLAGS="${configure.cppflags}" \
                        LDFLAGS="${configure.ldflags} [get_canonical_archflags]"

variant smb description {Enable Samba support} {
    depends_lib-append  port:samba3
    configure.args-append --enable-smb
}

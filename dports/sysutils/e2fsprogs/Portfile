# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem                  1.0

name                        e2fsprogs
version                     1.42.7
categories                  sysutils
platforms                   darwin
maintainers                 nomaintainer
license                     GPL-2 LGPL-2+ MIT BSD

description                 Utilities for use with the ext2, ext3 and ext4 \
                            filesystems

long_description            Utilities to create, check and manipulate extended 2, \
                            3 and 4 filesystem (ext2, ext3, ext4) which are \
                            commonly used on Linux.

homepage                    http://e2fsprogs.sourceforge.net/
master_sites                sourceforge:project/e2fsprogs/e2fsprogs/v${version}

checksums                   rmd160  365ce2a182e5adc988f3428634a8bed5d05910a2 \
                            sha256  dc6501b2e75d205e425196d753d92b129c568525d8aad08085c0aa69ee9e7345

depends_build               port:pkgconfig
depends_lib                 port:gettext

configure.args-append       --enable-bsd-shlibs


if {${name} == ${subport}} {
    configure.args-append       --disable-libuuid \
                                --disable-uuidd

    depends_lib-append          port:ossp-uuid \
                                port:libcomerr

    patchfiles-append           patch-lib__Makefile.darwin-lib \
                                patch-Makefile.in-remove-included-libcomerr.diff

    if {${configure.compiler} == "clang"} {
        # This project is not C99 conformant and has return type conflicts that
        # clang complains about
        configure.cflags-append  "--std=gnu89 -Wno-return-type"
    }

    pre-build {
        ln -fs ${prefix}/bin/compile_et ${worksrcpath}/lib/et/compile_et
        ln -fs ${prefix}/lib/libcom_err.1.1.dylib ${worksrcpath}/lib/libcom_err.dylib
    }

    universal_variant           no

    destroot.target-append      install-libs
}

subport libcomerr {
    license                     MIT BSD

    patchfiles-append           patch-lib__et__compile_et.sh.in.diff

    build.args-append           -C lib/et
    destroot.args-append        -C lib/et
    post-destroot {
        ln -fs libcom_err.1.1.dylib ${destroot}${prefix}/lib/libcom_err.dylib
        system "install_name_tool -id ${prefix}/lib/libcom_err.1.1.dylib ${destroot}${prefix}/lib/libcom_err.1.1.dylib"
    }

    pre-activate {
        if {![catch {set installed [lindex [registry_active kerberos5] 0]}]} {
            set version [lindex $installed 1]
            if {[vercmp $version 1.11] < 0} {
                # kerberos5 used to install some files now provided by libcomerr in versions < 1.11
                registry_deactivate_composite kerberos5 "" [list ports_nodepcheck 1]
            }
        }
    }
}

livecheck.type              regex
livecheck.regex             ${name}-(\[0-9.\]+)\\.tar

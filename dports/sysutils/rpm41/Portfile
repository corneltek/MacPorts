# $Id: Portfile,v 1.2 2003/11/10 17:27:55 ssen Exp $

PortSystem 1.0
name			rpm41
version			4.1.1
platforms		darwin
revision		0
categories		sysutils archivers
maintainers		ssen@opendarwin.org
description		RedHat Package Manager

#master_sites		ftp://ftp.rpm.org/pub/rpm/dist/rpm-4.1.x/
master_sites		http://distfiles.opendarwin.org/
checksums		md5 da4c87e95092aa9f0c85da3836e6b1c6
distname		rpm-${version}

depends_lib		lib:libbz2.1.0:bzip2 lib:libiconv.2:libiconv \
			bin:python:python

configure.args		--disable-nls --with-included-gettext \
			--with-glob --with-libiconv-prefix=${prefix} \
			--mandir=${prefix}/share/man

variant darwin {
	patchfiles-append \
		patch-db3-configure.diff        patch-rpmheader.diff \
		patch-dump.diff                 patch-rpmioc.diff \
		patch-dumpdb.diff               patch-rpmioh.diff \
		patch-lib-signature.diff        patch-rpmlead.diff \
		patch-macros-in.diff            patch-rpmqv.diff \
		patch-rpm2cpio.diff             patch-rpmsignature.diff \
		patch-rpmarchive.diff           patch-systemh.diff \
		patch-rpmrc.diff		patch-file-systemh.diff \
		patch-file-filec.diff		patch-rpmio-Makefile-in.diff \
		patch-fts.diff			patch-rpmrpc.diff \
		patch-rpmdb-Makefile-in.diff	patch-lib-Makefile-in.diff \
		patch-rpmdb-rpmdbc.diff		patch-build-Makefile-in.diff \
		patch-tools-rpmfile.diff	patch-tools-Makefile-in.diff \
		patch-Makefile-in.diff		patch-ltmain-sh.diff

#patch-rpmrc-in.diff

#		patch-autodeps-darwin-prov.diff	patch-autodeps-darwin-req.diff \
#		patch-python-rpmmodule.diff	patch-python-makefile-in.diff

	post-patch {
		system "rm -rf \"${worksrcpath}/elfutils\""
	}

	pre-configure {
	        system "mkdir -p ${workpath}/librt"
		system "ln -sf /usr/lib/libSystem.B.dylib \
				${workpath}/librt/librt.dylib"
	}

	configure.args-append --disable-optimized --disable-aio \
			      --with-python=no --without-javaglue \
		              --enable-broken-chown

	configure.env   LDFLAGS="-L${prefix}/lib -L${workpath}/librt" \
			CFLAGS="-I${prefix}/include -no-cpp-precomp" \
			CPPFLAGS=""

	post-destroot {
		# where the RPM database to lives
		system "mkdir -p '${destroot}${prefix}/var/lib/rpm'"
		system "touch '${destroot}${prefix}/var/lib/rpm/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/BUILD'"
		system "touch '${destroot}${prefix}/src/apple/BUILD/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/RPMS'"
		system "touch '${destroot}${prefix}/src/apple/RPMS/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/SOURCES'"
		system "touch '${destroot}${prefix}/src/apple/SOURCES/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/SPECS'"
		system "touch '${destroot}${prefix}/src/apple/SPECS/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/SRPMS'"
		system "touch '${destroot}${prefix}/src/apple/SRPMS/.turd'"
	}
}

--- /dev/null	Mon Jun  2 00:44:09 2003
+++ autodeps/darwin.req	Mon Jun  2 00:43:57 2003
@@ -0,0 +1,70 @@
+#!/usr/bin/perl
+# ----------------------------------------------------------------
+#	find-requires for Darwin
+# ----------------------------------------------------------------
+
+my %files;
+my @check;
+my %receipts;
+my $usereceipts = 0;
+
+if (exists $ENV{'DP_USERECEIPTS'}) {
+	my $directory = $ENV{'DP_USERECEIPTS'};
+	if (opendir(DIR, $directory)) {
+		for my $receipt (grep(!/^\.\.?$/, readdir(DIR))) {
+			chomp($receipt);
+			my $receiptopen;
+			if ($receipt =~ /\.bz2$/) {
+				$receiptopen = "bzip2 -dc $directory/$receipt |";
+			} else {
+				$receiptopen = "$directory/$receipt";
+			}
+			if (open(RECEIPT, $receiptopen)) {
+				while (my $contents = <RECEIPT>) {
+					while ($contents =~ /\G.*?MD5 \((.+?)\)/gs) {
+						$receipts{$1} = 1;
+					}
+				}
+				close(RECEIPT);
+			} else {
+				warn "couldn't read $receipt: $!\n";
+			}
+			closedir(DIR);
+		}
+		$usereceipts = 1;
+	} else {
+		warn "couldn't open receipt directory: $!\n";
+	}
+}
+
+while (my $FILE = <STDIN>) {
+	chomp $FILE;
+
+	next if (-d $FILE);
+
+	next if ($FILE =~ m,\.class$,);
+	next if ($FILE =~ m,/macosx-sysrpm/,);
+
+	my $FILE_esc = $FILE;
+	$FILE_esc =~ s/\'/\\\'/g;
+
+	for my $ARCH ('ppc', 'i386') {
+		if (open(OTOOL, "otool -arch '$ARCH' -L '$FILE_esc' 2>/dev/null |")) {
+			while (<OTOOL>) {
+				if (/^\s*([^\s].*)\s+\(compatibility version/) {
+					my $dep = $1;
+					next if ($usereceipts and not exists $receipts{$dep});
+					if ($dep =~ m,\.framework/.*,) {
+						$dep =~ s,^.*?/([^/]*?\.framework)/.*$,$1,;
+					}
+					$files{"$dep-$ARCH"} = 1;
+				}
+			}
+			close(OTOOL);
+		} else {
+			warn "couldn't run otool on '$FILE': $!\n";
+		}
+	}
+}
+
+print join("\n", sort keys %files), "\n";

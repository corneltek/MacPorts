# $Id: Portfile,v 1.10 2004/02/05 18:04:20 ssen Exp $

PortSystem 1.0
name			rpm
version			4.0.4
platforms		darwin
revision		6
categories		sysutils archivers
maintainers		ssen@opendarwin.org
description		RedHat Package Manager

master_sites		ftp://ftp.rpm.org/pub/rpm/dist/rpm-4.0.x/
checksums		md5 b0c3093d2f0d850760e59ac1db9bf152

depends_lib		lib:libbz2.1.0:bzip2 lib:libiconv.2:libiconv \
			bin:${prefix}/bin/python2.3:python23

configure.args		--disable-nls --with-included-gettext \
			--with-glob --with-libiconv-prefix=${prefix} \
			--mandir=${prefix}/share/man

configure.env		__PYTHON="${prefix}/bin/python"


variant darwin {
	patchfiles-append \
		patch-db3-configure.diff        patch-rpmheader.diff \
		patch-dump.diff                 patch-rpmioc.diff \
		patch-dumpdb.diff               patch-rpmioh.diff \
		patch-lib-signature.diff        patch-rpmlead.diff \
		patch-macros-in.diff            patch-rpmqv.diff \
		patch-rpm2cpio.diff             patch-rpmsignature.diff \
		patch-rpmarchive.diff           patch-systemh.diff \
		patch-rpmrc.diff		patch-rpmrc-in.diff \
		patch-autodeps-darwin-prov.diff	patch-autodeps-darwin-req.diff \
		patch-python-rpmmodule.diff	patch-python-makefile-in.diff \
		patch-configure.diff

	pre-configure {
	        system "mkdir -p ${workpath}/librt"
		system "ln -sf /usr/lib/libSystem.B.dylib \
				${workpath}/librt/librt.dylib"
	}

	configure.args-append --disable-optimized --disable-aio \
			      --with-python=auto --without-javaglue \
		              --enable-broken-chown

	configure.env-append   LDFLAGS="-L${prefix}/lib -L${workpath}/librt" \
			CFLAGS="-I${prefix}/include -no-cpp-precomp" \
			CC="gcc -flat_namespace" CPPFLAGS=""

	post-destroot {
		# where the RPM database to lives
		system "mkdir -p '${destroot}${prefix}/var/lib/rpm'"
		system "touch '${destroot}${prefix}/var/lib/rpm/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/BUILD'"
		system "touch '${destroot}${prefix}/src/apple/BUILD/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/RPMS'"
		system "touch '${destroot}${prefix}/src/apple/RPMS/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/SOURCES'"
		system "touch '${destroot}${prefix}/src/apple/SOURCES/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/SPECS'"
		system "touch '${destroot}${prefix}/src/apple/SPECS/.turd'"
		system "mkdir -p '${destroot}${prefix}/src/apple/SRPMS'"
		system "touch '${destroot}${prefix}/src/apple/SRPMS/.turd'"
	}
}

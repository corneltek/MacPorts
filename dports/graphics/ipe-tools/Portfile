# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name                    ipe-tools
version                 20140303
revision                2
categories              graphics
maintainers             jacobs-university.de:m.thon \
                        gmx.de:Torsten.Maehne \
                        openmaintainer
platforms               darwin
license                 {GPL-2 GPL-3}

description             Tools for the Ipe extensible drawing editor

long_description        The following tools for the Ipe extensible drawing \
                        editor are provided: \
                        svgtoipe, pdftoipe, figtoipe, ipe5toxml

homepage                http://ipe7.sourceforge.net/
master_sites            sourceforge:project/ipe7/tools

set svgtoipe-vers       20131107
set pdftoipe-vers       20140303
set figtoipe-vers       20091205
set ipe5toxml-vers      20051114

distfiles               svgtoipe-${svgtoipe-vers}${extract.suffix} \
                        pdftoipe-${pdftoipe-vers}-src${extract.suffix} \
                        figtoipe-${figtoipe-vers}${extract.suffix} \
                        ipe5toxml-${ipe5toxml-vers}${extract.suffix}

checksums               svgtoipe-${svgtoipe-vers}${extract.suffix} \
                            sha1    3a702dcd5bce542e7479d197f7e8b7a71d6a8fec \
                            rmd160  841f690fe3b9f9e6c00139c90606eaaf9f7c67b7 \
                        pdftoipe-${pdftoipe-vers}-src${extract.suffix} \
                            sha1    d6de3d6a2bad7e97cb3c545665dec40d5d9708f0 \
                            rmd160  9744f49d18b7bd72e610122c68d12230e457def5 \
                        figtoipe-${figtoipe-vers}${extract.suffix} \
                            sha1    b81f2f0cc568e165bdedb618ced9384ebfcb19a3 \
                            rmd160  cc1615b55313ab8c151565bdb498fff8ba945029 \
                        ipe5toxml-${ipe5toxml-vers}${extract.suffix} \
                            sha1    23cb8b40f1aa8a9bc4904d295b08fe0293cda7fc \
                            rmd160  44c22367e3ef3cb4607310d15af51f527b006be0

worksrcdir              .

patchfiles              patch-svgtoipe-python_path.diff

depends_build           port:pkgconfig
depends_lib             port:poppler

use_configure           no
use_parallel_build      no

eval build.env          CPPFLAGS+='${configure.cppflags}' \
                        CFLAGS+='${configure.cppflags} ${configure.cflags} ${configure.cc_archflags}' \
                        CXXFLAGS+='${configure.cxxflags} ${configure.cxx_archflags}' \
                        LDFLAGS+='${configure.cc_archflags}' \
                        CC=${configure.cc} CXX=${configure.cxx}

build {
        system "cd ${workpath}/figtoipe-${figtoipe-vers} && ${build.env} ${build.cmd} ${build.target} CXX=${configure.cxx}"
        system "cd ${workpath}/ipe5toxml && ${build.env} ${build.cmd}"
        system "cd ${workpath}/pdftoipe-${pdftoipe-vers}-src && ${build.env} CC=${configure.cxx} ${build.cmd} ${build.target}"
}

destroot {
        xinstall -m 755 ${workpath}/figtoipe-${figtoipe-vers}/figtoipe ${destroot}${prefix}/bin
        xinstall -m 644 ${workpath}/figtoipe-${figtoipe-vers}/figtoipe.1 ${destroot}${prefix}/share/man/man1
        xinstall -m 755 ${workpath}/ipe5toxml/ipe5toxml ${destroot}${prefix}/bin
        xinstall -m 755 ${workpath}/pdftoipe-${pdftoipe-vers}-src/pdftoipe ${destroot}${prefix}/bin
        xinstall -m 644 ${workpath}/pdftoipe-${pdftoipe-vers}-src/pdftoipe.1 ${destroot}${prefix}/share/man/man1
        xinstall -m 755 ${workpath}/svgtoipe-${svgtoipe-vers}/svgtoipe.py ${destroot}${prefix}/bin
}

set python.versions         {24 25 26 27}
set python.default_version  27

# create python variants
foreach ver ${python.versions} {

    set variant_line {variant python${ver} description "Use python${ver} and packages from MacPorts"}

    foreach over ${python.versions} {
        if {${ver} == ${over}} {
            continue
        }
        append variant_line " conflicts python${over}"
    }
    append variant_line { {}}
    eval $variant_line
}

# set default python variant
set variant_none true
foreach ver ${python.versions} {
    if {[variant_isset python${ver}]} {
        set variant_none [expr $variant_none && ![variant_isset python${ver}]]
    }
}
if {${variant_none}} {
    default_variants-append "+python${python.default_version}"
}

# python variant settings
foreach ver ${python.versions} {
    if {[variant_isset python${ver}]} {set python.version ${ver}}
}

# set derived python variables
set python.branch   "[string range ${python.version} 0 end-1].[string index ${python.version} end]"
set python.pkgd     ${frameworks_dir}/Python.framework/Versions/${python.branch}/lib/python${python.branch}/site-packages

if { ${python.version} <= 25 } {
    depends_lib-append  port:py${python.version}-pil
} else {
    depends_lib-append  path:${python.pkgd}/PIL:py${python.version}-Pillow
}

post-patch {
    reinplace "s|__MP_PYTHON_BIN__|${prefix}/bin/python${python.branch}|" ${workpath}/svgtoipe-${svgtoipe-vers}/svgtoipe.py
}

livecheck.type  regex
livecheck.url   http://sourceforge.net/projects/ipe7/files/tools/
livecheck.regex "to(?:ipe|xml)-(\[0-9\]*)"

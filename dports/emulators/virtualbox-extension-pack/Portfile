# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                virtualbox-extension-pack
version             4.1.12
set version_build   77245
categories          emulators
platforms           darwin
maintainers         pixilla openmaintainer
license             PUEL

description         Oracle VM VirtualBox Extension Pack
long_description    ${description}

homepage            http://www.virtualbox.org/
master_sites        http://download.virtualbox.org/virtualbox/${version}/

supported_archs     i386
# When MacPorts virtualbox supports 64bit we will need to map build archs to {x86 amd64}.
set install_archs   {x86}
depends_run         port:virtualbox

set name_extpack    Oracle_VM_VirtualBox_Extension_Pack
distname            ${name_extpack}-${version}-${version_build}

checksums           rmd160  0a65fb69ad482c655f564a3f63ed958390c26c48 \
                    sha256  57a98286a9393e49c36ab8873878a89d0ac6b1179bf9a5c0d5fd517e272a8881

worksrcdir          ${name}/${name_extpack}
extract.suffix      .vbox-extpack
extract.mkdir       yes

use_configure       no

set app_dir VirtualBox.app
set lib_dir ${app_dir}/Contents/MacOS
set ext_dir ${lib_dir}/ExtensionPacks
build {

    # The pre-built libraries use weird prefixes and Oracle recommends setting
    # DYLD_LIBRARY_PATH to deal with this. I would rather fix the paths in the
    # libraries at install time.
    foreach {arch} $install_archs {

        foreach lib [glob -directory ${worksrcpath}/darwin.${arch} *.dylib*] {

            system "install_name_tool -id ${applications_dir}/${ext_dir}/${name_extpack}/darwin.${arch}/[strsed ${lib} /^.*\\///] ${lib}"
            
            # Then for each dependent dylib with a weird path that this dylib
            # references, fix the reference to use ${lib_dir}.
            foreach dep [exec otool -L ${lib}] {

                if [string match "/Applications/${lib_dir}/*" ${dep}] {

                    system "install_name_tool -change ${dep} ${applications_dir}/${lib_dir}/[strsed ${dep} /^.*\\///] ${lib}"
                }
            }
        }
    }
}

destroot {

    xinstall -d -o root -g admin -m 755 ${destroot}${applications_dir}/${ext_dir}/${name_extpack}
    foreach {f} [glob -directory ${worksrcpath} -type f *] {

        xinstall -o "root" -g "admin" -m 0755 ${f} \
            ${destroot}${applications_dir}/${ext_dir}/${name_extpack}
    }
    foreach {arch} $install_archs {

        xinstall -o "root" -g "admin" -m 0755 -d \
            ${destroot}${applications_dir}/${ext_dir}/${name_extpack}/darwin.${arch}
        foreach {f} [glob -directory ${worksrcpath}/darwin.${arch} *] {

            xinstall -o "root" -g "admin" -m 0755 ${f} \
                ${destroot}${applications_dir}/${ext_dir}/${name_extpack}/darwin.${arch}
        }
    }
}

livecheck.type      regex
livecheck.url       https://www.virtualbox.org/wiki/Downloads
livecheck.version   ${version}-${version_build}
livecheck.regex     "/Oracle_VM_VirtualBox_Extension_Pack-(\\d(?!\\${extract.suffix}).*)\\${extract.suffix}"

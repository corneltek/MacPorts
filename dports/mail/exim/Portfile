# $Id: Portfile,v 1.15 2003/08/05 09:29:17 jkh Exp $

PortSystem 1.0
name            exim
version         4.20
categories      mail
description     complete replacement for sendmail
long_description        Exim is a mail transfer agent (MTA) developed \
                        at the University of Cambridge for use on Unix \
                        systems connected to the Internet. It is freely \
                        available under the terms of the GNU General \
                        Public Licence. In overall style it is similar \
                        to Smail 3, but its facilities are more extensive.
homepage        http://www.exim.org/
platforms       darwin
maintainers     fkr@opendarwin.org
master_sites    ftp://ftp.csx.cam.ac.uk/pub/software/email/exim/exim4/ \
                ftp://ftp.exim.org/pub/exim/exim4/
checksums	exim-4.20.tar.gz md5 a1f06f1de1ab602a25d78ad2a20819f2 
depends_lib     path:/usr/include/netinet/ip_var.h:netinet-headers
depends_build   bin:perl:perl5.8
depends_run 	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

set exim_user   exim

configure   {   cd ${worksrcpath}
                system "cp src/EDITME Local/Makefile"
                reinplace "s|/usr/exim/bin|${prefix}/sbin|g" Local/Makefile
                reinplace "s|/usr/exim/configure|${prefix}/etc/exim/exim.conf|g" Local/Makefile
                reinplace "s|EXIM_USER=|EXIM_USER=${exim_user}|g" Local/Makefile
                reinplace "s|/var/spool/exim|${prefix}/var/spool/exim|g" Local/Makefile
                reinplace "s|EXIM_MONITOR=eximon.bin|#EXIM_MONITOR=eximon.bin|g" Local/Makefile

#Should be in pre-deployment/user addition phase

adduser ${exim_user} gid=[existsgroup mail] }
destroot.vars ROOT=${destroot}

post-destroot {  system "install -o root -m 755 -d ${prefix}/share/exim"
                 cd ${worksrcpath}
                 system "cp -R doc/ ${prefix}/share/exim"
                 system "install -o ${exim_user} -g mail -m 750 -d ${prefix}/var/spool/exim"
                 system "install -o root -m 755 -d ${prefix}/etc/rc.d"
                 system "install -o root -m 755 -c \
                     ${portpath}/files/exim.sh ${prefix}/etc/rc.d"
                 reinplace "s|__PREFIX|${prefix}|g" ${prefix}/etc/rc.d/exim.sh }

variant smtp-auth { }

variant exiscan {
		patch_sites 	 	http://duncanthrax.net/exiscan-acl/
		patchfiles 		exiscan-acl-4.20-08.patch	
        	checksums-append        exiscan-acl-4.20-08.patch md5 40ce678d91bdef2672acba889d87f11c	
		patch.pre_args 		-p1 }

variant mysql { depends_lib-append      lib:libmysqlclient:mysql }

variant	maildir { }

post-configure {
	
	if {[variant_isset mysql]} {
		reinplace "s|# LOOKUP_MYSQL=yes|LOOKUP_MYSQL=yes|g" Local/Makefile
		reinplace "s|# LOOKUP_INCLUDE=.*|LOOKUP_INCLUDE=-I ${prefix}/include/mysql -I ${prefix}/include -I /usr/include|g" Local/Makefile
		reinplace "s|# LOOKUP_LIBS=.*|LOOKUP_LIBS=-L${prefix}/lib/mysql -L${prefix}/lib -L/usr/lib -lmysqlclient|g" Local/Makefile
	}

	if {[variant_isset maildir ]} {
 		reinplace "s|# SUPPORT_MAILDIR=yes|SUPPORT_MAILDIR=yes|g" Local/Makefile       
	}

	if {[variant_isset smtp_auth ]} {
		reinplace "s|#AUTH_CRAM_MD5=yes|AUTH_CRAM_MD5=yes|g" Local/Makefile
                reinplace "s|#AUTH_PLAINTEXT=yes|AUTH_PLAINTEXT=yes|g" Local/Makefile
                reinplace "s|#AUTH_SPA=yes|AUTH_SPA=yes|g" Local/Makefile	
	}
}

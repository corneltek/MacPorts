PortSystem 1.0
name		courier-imap
version	 	2.0.0	
categories	mail
maintainers	bchesneau@mac.com
description	IMAP server
long_description	This package contains the standalone Courier IMAP server, \
			which is used to provide IMAP access to local mailboxes. \
			Courier-IMAP is provided here as a separate package that \
			can be used with other mail servers as well.

homepage	http://prdownloads.sourceforge.net/courier/
platforms	darwin
master_sites	sourceforge:courier
use_bzip2	yes
checksums	courier-imap-2.0.0.tar.bz2 md5 636816de2338eac4ad66d9d406020cba
depends_lib    	lib:libssl.0.9:openssl
depends_run 	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

set authdaemondir ${prefix}/var/run/authdaemon.courier-imap

configure.env	CFLAGS=-no-cpp-precomp \
		LANG=C
 
configure.args	--bindir=${prefix}/bin --mandir=${prefix}/share/man \
		--sysconfdir=${prefix}/etc/courier \
		--localstatedir=${prefix}/var/run \
		--datadir=${prefix}/share/courier \
		--with-piddir=${prefix}/var/run \
		--with-authdaemonvar=${authdaemondir} \
		--enable-workarounds-for-imap-client-bugs \
		--enable-unicode=iso-8859-1,utf-8 --disable-root-check

variant darwin {
	depends_lib-append      lib:libdl.1:dlcompat
	patchfiles      	patch-rfc1035_res.h
	configure.args-append	--with-waitfunc=wait3
}

variant mysql {
	depends_lib-append      lib:libmysqlclient:mysql
	configure.env-append	LDFLAGS=-L${prefix}/lib/mysql \
				CPPFLAGS=-I${prefix}/include/mysql
}

variant postgres { 
	configure.env-append    LDFLAGS=-L${prefix}/lib -L${prefix}/pgsql/lib \
				CPPFLAGS=-I${prefix}/include/ -I${prefix}/pgsql/include
        depends_lib-append      lib:plpgsql:postgresql
} 

variant berkdb { 
	depends_lib-append	lib:libdb-4.1:db4	
	configure.env-append	CPPFLAGS=-I${prefix}/include/db4
}

pre-configure {
	
	if { ![variant_isset mysql]} {
		configure.args-append --without-authmysql
	}
	if { ![variant_isset ldap]} {
                configure.args-append --without-authldap
        }
	if { ![variant_isset pam]} { 
                configure.args-append --without-authpam 
        }
	if { ![variant_isset postgres]} { 
                configure.args-append --without-authpostgresql 
        }
	if { [variant_isset berkdb]} { 
		configure.args-append --with-db=db
	}
}


destroot {
	system "cd ${workpath}/${worksrcdir}"
	system "make install DESTDIR=${destroot}"
	system "make install-configure DESTDIR=${destroot}"
}

post-destroot {
	file mkdir ${destroot}${prefix}/var/run
	file mkdir ${destroot}${prefix}/etc/rc.d
	file mkdir ${destroot}${authdaemondir} 
	system "touch ${destroot}${authdaemondir}/.turd"

	system "install -o root -m 755 -c \
                      ${portpath}/files/*.sh ${destroot}${prefix}/etc/rc.d"
	reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/rc.d/imapd.sh
	reinplace "s|ulimit|#ulimit|g" ${destroot}${prefix}/libexec/imapd.rc
	reinplace "s|ulimit|#ulimit|g" ${destroot}${prefix}/libexec/imapd-ssl.rc
}

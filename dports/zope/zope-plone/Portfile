# $Id: Portfile,v 1.1 2004/02/16 00:24:35 rshaw Exp $
PortSystem 1.0

name			zope-plone
version			2.0
categories		www zope python
maintainers		rshaw@opendarwin.org
description		A user friendly implementation of the CMF written on top of Zope
long_description	Plone is a user friendly implementation of the \
					Content Management Framework written on top of \
					ZOPE.  Plone is a GUI/Interface/Implementation \
					of the CMF.  It benefits from all features of \
					ZOPE/CMF such as: RDBMS integration, Python/Perl \
					extensions, Object Oriented Database, Web \
					configurable workflow, pluggable membership and \
					authentication, Undos, Form validation, amongst \
					many many other features.
platforms		darwin freebsd
homepage		http://www.plone.org/
master_sites	sourceforge:plone
dist_subdir		zope/${name}
distname		CMFPlone-${version}
distfiles		CMFPlone${version}${extract.suffix}
checksums		md5 2623f18f734201790056efff23fe728d

# Use Python 2.3 from DarwinPorts explicitly 
set python		${prefix}/bin/python2.3

# Location to install Zope products and the Zope user                  
set zopehome	${prefix}/libexec/Zope
set zopeinst	${prefix}/www/Zope
set zopeprod	${zopehome}/lib/python/Products
set zopeuser	zope
set zopegroup	www

# Depends on Zope
depends_build	path:${zopehome}:zope

# Depends on these Zope products
depends_run		path:${zopeprod}/BTreeFolder2:zope-btreefolder2 \
				path:${zopeprod}/CMFCore:zope-cmf

platform freebsd {
	extract.post_args	| gtar -xf -
}

use_configure	no

pre-build {
	file copy ${zopehome}/bin/compilezpy.py ${workpath}
	reinplace "s|^.*sys.stdout|#&|" ${workpath}/compilezpy.py
	system "find ${worksrcpath} -name '*.py\[co\]' | xargs rm"
}

build {
	foreach product {CMFPlone CMFActionIcons CMFFormController \
			CMFQuickInstallerTool Formulator GroupUserFolder \
			PlacelessTranslationService} {
		system "cd ${worksrcpath}/${product} && \
			${python} ${workpath}/compilezpy.py"
	}
}

destroot {
	if {$env(USER) != "root"} {
		ui_msg "------------------------------------------------------------"
		ui_msg "Note that you are not installing as root, so files installed"
		ui_msg "by this port will not end up with proper ownership and"
		ui_msg "likely not work correctly with Zope."
		ui_msg "------------------------------------------------------------"
	}

	# Install products
	xinstall -d -m 0755 ${destroot}${zopeprod}
	foreach product {CMFPlone CMFActionIcons CMFFormController \
			CMFQuickInstallerTool Formulator GroupUserFolder \
			PlacelessTranslationService} {
		system "cp -R ${worksrcpath}/${product} ${destroot}${zopeprod}"
	}
	if {$env(USER) == "root"} {
		system "chown -R ${zopeuser} ${destroot}${zopehome}"
		system "chgrp -R ${zopegroup} ${destroot}${zopehome}"
	}

	# Install docs
	set docPath ${destroot}${prefix}/share/doc
	xinstall -d -m 0755 ${docPath}
	system "cp -R ${worksrcpath}/CMFPlone/docs ${docPath}/Plone"
}


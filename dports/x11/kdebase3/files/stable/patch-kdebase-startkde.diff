--- startkde	6 May 2003 17:48:14 -0000	1.1.1.8
+++ startkde	14 May 2003 13:43:52 -0000	1.13
@@ -34,6 +34,10 @@
 # people's heads. We use colours from the standard KDE palette for those with
 # palettised displays.
 
+# we have to unset this for Darwin since it will screw up KDE's dynamic-loading
+unset DYLD_FORCE_FLAT_NAMESPACE
+test -d "@PREFIX@" && export PATH="@PREFIX@/bin:${PATH}"
+
 test "$XDM_MANAGED" || bkg="-solid #C0C0C0"
 xsetroot -cursor_name left_ptr $bkg
 
@@ -110,6 +114,11 @@
     export GS_LIB
 fi
 
+# if we're in Apple's X11 and the native window manager is available, use that
+if test -z "$KDEWM" && test -x /usr/X11R6/bin/quartz-wm; then
+    KDEWM="/usr/X11R6/bin/quartz-wm"
+fi
+
 # Link "tmp" resource to directory in /tmp
 # Creates a directory /tmp/kde-$USER and links $KDEHOME/tmp-$HOSTNAME to it.
 lnusertemp tmp >/dev/null
@@ -128,7 +137,11 @@
     # start only dcopserver, don't start whole kdeinit (takes too long)
     echo 'startkde: Running kpersonalizer...'  1>&2
     dcopserver
-    kwin &
+    if test -n "$KDEWM"; then
+        $KDEWM &
+    else
+        kwin &
+    fi
     kpersonalizer --before-session
     # handle kpersonalizer restarts (language change)
     while test $? -eq 1; do
@@ -139,7 +152,6 @@
     sleep 1
 fi
 
-# the splashscreen and progress indicator
 ksplash
 
 # We set LD_BIND_NOW to increase the efficiency of kdeinit.
@@ -150,6 +162,10 @@
   echo 'startkde: Could not start kdeinit. Check your installation.'  1>&2
   xmessage -geometry 500x100 "Could not start kdeinit. Check your installation."
 fi
+
+# fix up KDE themes
+echo 'startkde: updating theme cache'
+kwrapper kinstalltheme
 
 # finally, give the session control to the session manager
 # if the KDEWM environment variable has been set, then it will be used as KDE's

--- kdesktop/Makefile.am	1 Oct 2002 02:35:37 -0000	1.1.1.3
+++ kdesktop/Makefile.am	1 Jun 2003 14:31:54 -0000	1.4
@@ -1,10 +1,6 @@
 ## Makefile.am of kdebase/kdesktop
 
 INCLUDES = -I$(top_srcdir)/kcontrol/background -I$(top_srcdir)/libkonq $(all_includes)
-kdesktop_la_LDFLAGS  = $(KDE_RPATH) $(all_libraries) -module -avoid-version
-kdesktop_la_LIBADD   = $(top_builddir)/libkonq/libkonq.la $(top_builddir)/kcontrol/background/libbgnd.la 
-kdesktop_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
-kdesktop_LDADD    = kdesktop.la
 
 SUBDIRS = . lock pics patterns programs init kwebdesktop
 
@@ -12,15 +8,29 @@
 
 bin_PROGRAMS = kdesktop
 bin_SCRIPTS = kdeeject
-lib_LTLIBRARIES = kdesktop.la
+lib_LTLIBRARIES = kdesktop.la libkdesktop_main.la
 
-kdesktop_la_SOURCES = main.cc krootwm.cc xautolock.cc kdiconview.cc desktop.cc \
+libkdesktop_main_la_LDFLAGS  = $(KDE_RPATH) $(all_libraries) -avoid-version -no-undefined
+libkdesktop_main_la_LIBADD   = $(top_builddir)/libkonq/libkonq.la $(top_builddir)/kcontrol/background/libbgnd.la 
+libkdesktop_main_la_SOURCES = main.cc krootwm.cc xautolock.cc kdiconview.cc desktop.cc \
 	lockeng.cc KDesktopIface.skel \
 	bgmanager.cc init.cc KScreensaverIface.skel \
 	minicli.cpp KBackgroundIface.skel pixmapserver.cc kcustommenu.cc \
 	startupid.cpp
 
-kdesktop_SOURCES = dummy.cc
+kdesktop_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -avoid-version -module
+kdesktop_la_LIBADD  = libkdesktop_main.la
+kdesktop_la_SOURCES = kdesktop_la_main.cpp
+
+kdesktop_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kdesktop_la_main.cpp
+
+kdesktop_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
+kdesktop_LDADD    = libkdesktop_main.la
+kdesktop_SOURCES  = kdesktop_main.cpp
+
+kdesktop_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kdesktop_main.cpp
 
 include_HEADERS = KDesktopIface.h KScreensaverIface.h KBackgroundIface.h
 

--- ksmserver/Makefile.am	10 Jul 2002 03:24:29 -0000	1.1.1.2
+++ ksmserver/Makefile.am	1 Jun 2003 14:31:56 -0000	1.7
@@ -20,18 +20,28 @@
 INCLUDES=  $(all_includes)
 
 bin_PROGRAMS = ksmserver
-lib_LTLIBRARIES = ksmserver.la
+lib_LTLIBRARIES = ksmserver.la libksmserver_main.la
 noinst_HEADERS = global.h server.h shutdown.h
 
-ksmserver_la_METASOURCES = AUTO
+libksmserver_main_la_METASOURCES = AUTO
 # Order is important for --enable-final!
-ksmserver_la_SOURCES = main.cpp server.cpp shutdown.cpp KSMServerInterface.skel
-ksmserver_SOURCES = dummy.cpp
+libksmserver_main_la_SOURCES = main.cpp server.cpp shutdown.cpp KSMServerInterface.skel
+libksmserver_main_la_LDFLAGS = $(all_libraries) -avoid-version $(QT_LDFLAGS) -no-undefined
+libksmserver_main_la_LIBADD = $(LIB_KDEUI) $(LIB_QT) -lkdecore -lDCOP
 
+ksmserver_la_SOURCES = ksmserver_la_main.cpp
 ksmserver_la_LDFLAGS = $(all_libraries) -avoid-version -module
+ksmserver_la_LIBADD  = libksmserver_main.la
+
+ksmserver_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > ksmserver_la_main.cpp
+
+ksmserver_SOURCES = ksmserver_main.cpp
 ksmserver_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-ksmserver_la_LIBADD = $(LIB_KDEUI)
-ksmserver_LDADD = ksmserver.la
+ksmserver_LDADD   = libksmserver_main.la
+
+ksmserver_main.cpp: stub_main.cpp
+	cat stub_main.cpp > ksmserver_main.cpp
 
 picsdir = $(kde_datadir)/ksmserver/pics
 pics_DATA = shutdownkonq.png
@@ -47,6 +57,3 @@
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/ksmserver.pot
-
-dummy.cpp:
-	echo > dummy.cpp

# $Id: Portfile,v 1.27 2003/06/02 09:39:31 michaelm Exp $

PortSystem 1.0
name                apache
version             1.3.27
revision            1.0
categories          www
platforms           darwin freebsd
maintainers         michaelm@opendarwin.org
description         The extremely popular Apache http server
homepage            http://httpd.apache.org/
master_sites        http://www.tux.org/pub/net/apache/dist/httpd/ \
                      http://apache.mirror.digitalspace.net/httpd/ \
                      http://www.apache.inetcosmos.org/dist/httpd/ \
                      http://www.rge.com/pub/infosystems/apache/httpd/ \
                      http://www.tux.org/pub/net/apache/dist/httpd/ \
                      http://apache.mirror.digitalspace.net/httpd/ \
                      http://www.rge.com/pub/infosystems/apache/httpd/ \
                      http://ftp.epix.net/apache/httpd/ 
                      

distname            ${name}_${version}
checksums           ${distname}${extract.sufx} md5 65b89365a65dcad71d4402b4862beeaa
configure.pre_args  --prefix=${prefix}/${name}-${version}
configure.args      --with-layout=FreeBSD --server-uid=www \
                      --server-gid=www  --enable-module=most \
                      --enable-shared=max --disable-rule=expat \
                      --logfiledir=${prefix}/${name}-${version}/var/log/httpd \
                      --runtimedir=${prefix}/${name}-${version}/var/run


install.args		root=${destroot}

post-install      { file mkdir  ${prefix}/${name}-${version}/var/log/httpd 
	                    file mkdir  ${prefix}/${name}-${version}/var/run
                  }

variant activate_server {
        depends_run path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup
	post-patch        { system "sed -e \"s=%%PREFIX%%=${prefix}/${name}-${version}=g\" \
                     ${filespath}/apache.sh >${workpath}/apache.sh"
                  }
                 
                 

	post-install      { file mkdir  ${prefix}/${name}-${version}/var/log/httpd 
	                    file mkdir  ${prefix}/${name}-${version}/var/run
                        file mkdir  ${prefix}/etc/rc.d/
					    system "touch ${destroot}${prefix}/${name}-${version}/var/run/.turd \
						                ${destroot}${prefix}/${name}-${version}/var/log/httpd/.turd"
	                    system "install -bC -o root ${workpath}/apache.sh \
	                                     ${destroot}${prefix}/etc/rc.d/"
	                 }
}

variant mod_perl {
				
        master_sites-append        http://mirror.telentente.com/pub/apache/dist/perl:perl/ \
                                   http://apache.mirror.digitalspace.net/perl/:perl \
                                   http://www.apache.inetcosmos.org/dist/perl/:perl \
                                   http://www.rge.com/pub/infosystems/apache/perl/:perl \
                                   http://mirrors.ccs.neu.edu/Apache/dist/perl/:perl 
	
        distname            ${name}_${version}
        distfiles-append    mod_perl-1.27${extract.sufx}:perl
        extract.only        ${distname}${extract.sufx} mod_perl-1.27${extract.sufx}
	
        checksums-append    mod_perl-1.27${extract.sufx} md5 bd07f4f1065eb0d0a8d8004219357d8c
	
        depends_lib         bin:perl5\.8\..:perl5.8
        worksrcdir          mod_perl-1.27
	
	configure.pre_args 
        #APACI_ARGS all on one line because otherwise apache gets upset if the shell is csh/tcsh
        configure         { system "cd ${workpath}/${worksrcdir} && \
						 perl Makefile.PL USE_APACI=1 EVERYTHING=1 \
						 DO_HTTPD=1 APACHE_PREFIX=${prefix} \
						 APACHE_SRC=../${distname}/src \
						 APACI_ARGS='--prefix=${prefix}/${name}-${version} --logfiledir=${prefix}/${name}-${version}/var/log/httpd --runtimedir=${prefix}/${name}-${version}/var/run --with-layout=FreeBSD --server-uid=www --server-gid=www --enable-module=most --enable-shared=max --disable-shared=perl --disable-rule=expat'" }
	
        install.args	PREFIX=${destroot}${prefix} INSTALLPRIVLIB=${destroot}${prefix}/lib/perl5/5.8.0 \
                         INSTALLSITELIB=${destroot}${prefix}/lib/perl5/site_perl/5.8.0 \
                         INSTALLARCHLIB=${destroot}${prefix}/lib/perl5/5.8.0/darwin \
                         INSTALLSITEARCH=${destroot}${prefix}/lib/perl5/site_perl/5.8.0/darwin \
root=${destroot}

        post-install      { file mkdir  ${prefix}/var/log/httpd ${prefix}/var/run
                            system "touch ${destroot}${prefix}/${name}-${version}/var/log/httpd/.turd \
                                    ${destroot}${prefix}/${name}-${version}/var/run/.turd"
                              cd ${destroot}${prefix}/lib/perl5/site_perl/5.8.0/darwin/auto/mod_perl/
                              system "cat .packlist | sed s#${destroot}/##g >.packlist.new"
                              system "mv .packlist.new .packlist"
                           }
	
}

long_description \
  Apache is an HTTP server designed as a plug-in replacement for \
  the NCSA server version 1.3 (or 1.4). It fixes numerous bugs in \
  the NCSA server and includes many frequently requested new \
  features, and has an API which allows it to be extended to meet \
  users' needs more easily.

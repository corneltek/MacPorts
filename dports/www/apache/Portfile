PortSystem 1.0
name			apache
version			1.3.27
revision		1.0

categories		www
platforms		darwin freebsd

maintainers		mike+apacheport@gene-hacker.net
description		The extremely popular Apache http server

long_description \
  Apache is an HTTP server designed as a plug-in replacement for \
  the NCSA server version 1.3 (or 1.4). It fixes numerous bugs in \
  the NCSA server and includes many frequently requested new \
  features, and has an API which allows it to be extended to meet \
  users' needs more easily.

master_sites		http://www.apache.org/dist/httpd/
distname		${name}_${version}
checksums		${distname}${extract.sufx} md5 65b89365a65dcad71d4402b4862beeaa


configure.args		--with-layout=FreeBSD --server-uid=www \
			--server-gid=www --logfiledir=${prefix}/var/httpd \
			--runtimedir=${prefix}/var/run --enable-module=most \
			--enable-shared=max

post-patch {
	system "sed -e \"s=%%PREFIX%%=${prefix}=g\" ${filespath}/apache.sh >${portpath}/apache.sh"
}


post-install {
	file mkdir ${prefix}/var/log/httpd ${prefix}/var/run
	file mkdir ${prefix}/etc/rc.d/
	system "install -bC -o 0 ${portpath}/apache.sh ${prefix}/etc/rc.d/"
}

include		contents





#static mod_perl apache
#mod_perl will seg-fault if Apache::Request and Apache::Cookie are used together
#if you need both, use the mod_perl_expt variant below.
variant mod_perl {
				
master_sites-append	http://www.apache.org/dist/perl/:perl

distname			${name}_${version}
distfiles-append	mod_perl-1.27${extract.sufx}:perl
extract.only 		${distname}${extract.sufx} mod_perl-1.27${extract.sufx}

checksums-append	mod_perl-1.27${extract.sufx} md5 bd07f4f1065eb0d0a8d8004219357d8c

depends_lib bin:perl5\.8\..:perl5.8
worksrcdir mod_perl-1.27

post-patch {
	system "sed -e \"s=%%PREFIX%%=${prefix}=g\" ${filespath}/apache.sh >${portpath}/apache.sh"
}

#APACI_ARGS all on one line because otherwise apache gets upset if the shell is csh/tcsh
configure 	{system "cd /Volumes/Data/OD/darwinports/dports/www/apache/work/mod_perl-1.27 && \
				perl Makefile.PL USE_APACI=1 EVERYTHING=1 \
				DO_HTTPD=1 APACHE_PREFIX=${prefix} \
				APACHE_SRC=../${distname}/src \
				APACI_ARGS='--with-layout=FreeBSD --server-uid=www --server-gid=www --logfiledir=${prefix}/var/httpd --runtimedir=${prefix}/var/run --enable-module=most --enable-shared=max --disable-shared=perl'" }


post-install {
	file mkdir  ${prefix}/var/log/httpd ${prefix}/var/run
	file mkdir  ${prefix}/etc/rc.d/
	system "install -bC -o 0 ${portpath}/apache.sh ${prefix}/etc/rc.d/"
}

include contents-mod_perl

}


#static mod_perl apache with the lightweight libapreq that works on Darwin/Mac OSX
#normal mod_perl will seg-fault if Apache::Request and Apache::Cookie are used together
variant mod_perl_expt {
				
master_sites-append	http://www.apache.org/dist/perl/:perl \
					http://www.apache.org/~joes/:apreq

distname			${name}_${version}
distfiles-append	mod_perl-1.27${extract.sufx}:perl \
					apreq${extract.sufx}:apreq
extract.only 		${distname}${extract.sufx} mod_perl-1.27${extract.sufx} \
					apreq${extract.sufx}
				
patch_sites http://www.apache.org/~joes/
patchfiles apreq.patch

checksums-append	mod_perl-1.27${extract.sufx} md5 bd07f4f1065eb0d0a8d8004219357d8c \
					apreq${extract.sufx} md5 122f54f2f3ab6bf76370558d92a7e086 \
					apreq.patch md5 585180d82c20767d48c04fb2b7320aec
			
depends_lib bin:perl5\.8\..:perl5.8
worksrcdir mod_perl-1.27
		
patch {system "cd ${workpath}/${distname} && cp ${distpath}/apreq.patch . \
		&& patch -p0 < apreq.patch"}


post-patch {
	system "sed -e \"s=%%PREFIX%%=${prefix}=g\" ${filespath}/apache.sh >${portpath}/apache.sh"
}

configure.cmd 	
#APACI_ARGS all on one line because otherwise apache gets upset if the shell is csh/tcsh
configure 	{system "cd /Volumes/Data/OD/darwinports/dports/www/apache/work/mod_perl-1.27 && \
				perl Makefile.PL USE_APACI=1 EVERYTHING=1 \
				DO_HTTPD=1 APACHE_PREFIX=${prefix} \
				APACHE_SRC=../${distname}/src \
				APACI_ARGS='--with-layout=FreeBSD --server-uid=www --server-gid=www --logfiledir=${prefix}/var/httpd --runtimedir=${prefix}/var/run --enable-module=most --enable-shared=max --disable-shared=perl'" }

post-install {
	file mkdir  ${prefix}/var/log/httpd ${prefix}/var/run
	file mkdir  ${prefix}/etc/rc.d/
	system "install -bC -o 0 ${portpath}/apache.sh ${prefix}/etc/rc.d/"
	system "cd ${workpath}/httpd-apreq && perl Makefile.PL"
	system "cd ${workpath}/httpd-apreq  && make && make install"
}

include contents-mod_perl_expt

}


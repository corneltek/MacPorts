# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                midori
version             0.5.6

categories          www
platforms           darwin
license             MIT
maintainers         afb openmaintainer

description         Midori is a lightweight, Webkit-Gtk based web browser
long_description    ${description}

homepage            http://midori-browser.org
master_sites        http://midori-browser.org/downloads
use_bzip2	    yes

distname            midori_${version}_all_
worksrcdir          midori-${version}

checksums           sha1    951d68d26c0d7691eea5fbf3b29404d47f0a0504 \
                    rmd160  874c3bab803f5c69ee92abbd53d77ff5d0b9fe92 \
                    sha256  c5be1b5d9933776f09c5cab7945a073a820d65555e51fda9ff55fd063843f24a

depends_build       port:pkgconfig \
                    port:intltool

# glib 2.16.5 or later is required:
depends_lib         port:gtk2 \
                    path:include/gio/gio.h:glib2 \
                    path:lib/pkgconfig/webkit-1.0.pc:webkit-gtk\
                    port:libxml2 \
                    port:libunique \
                    port:libnotify \
                    port:vala

# Not autoconf
configure.universal_args-delete --disable-dependency-tracking

# Needs zeitgeist-1.0, but we have zeitgeist-2.0 ... check a later version
configure.args-append --disable-zeitgeist

# TODO: Check ${configure.cxx_stdlib} directly once MacPorts 2.3 is released
platform darwin {
    set cxxstdlib {}

    if {[info exists configure.cxx_stdlib] &&
        ${configure.cxx_stdlib} ne {} &&
        [string match *clang* ${configure.cxx}]} {
        set cxxstdlib ${configure.cxx_stdlib}
    } elseif {[string match *clang* ${configure.cxx}] &&
              ${os.major} >= 13} {
        set cxxstdlib libc++
    } else {
        set cxxstdlib libstdc++
    }

    if {${cxxstdlib} eq "libstdc++"} {
       depends_lib-delete path:lib/pkgconfig/webkit-1.0.pc:webkit-gtk
       depends_lib-append path:lib/pkgconfig/webkit-1.0.pc:webkit-gtk-2.0
    }

    post-destroot {
        # TODO: Fix the build system
        system "install_name_tool -id ${prefix}/lib/libmidori-core.1.dylib ${destroot}${prefix}/lib/libmidori-core.1.dylib"
        system "install_name_tool -change libmidori-core.1.dylib ${prefix}/lib/libmidori-core.1.dylib ${destroot}${prefix}/bin/midori" 

        foreach file [glob ${destroot}${prefix}/lib/midori/*.so] {
            system "install_name_tool -change libmidori-core.1.dylib ${prefix}/lib/libmidori-core.1.dylib ${file}" 
        }
    }
}

variant quartz description {Disable libnotify support (doesn't work with gtk2+quartz)} {
    depends_lib-delete      port:libnotify
    configure.args-append   --disable-libnotify
}

livecheck.url       ${homepage}
livecheck.regex     ${name}-(\[0-9.a-z\]*)\.tar\.bz2
livecheck.type      regexm

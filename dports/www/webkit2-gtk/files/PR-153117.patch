From d88f798c7719a3f72366a0f8aca3a556907fbb3e Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Thu, 14 Jan 2016 23:24:26 -0800
Subject: [PATCH 1/2] Fix linking on darwin

https://bugs.webkit.org/show_bug.cgi?id=153117

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 Source/cmake/OptionsGTK.cmake | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/Source/cmake/OptionsGTK.cmake b/Source/cmake/OptionsGTK.cmake
index ebb525a..d3e67ea 100644
--- Source/cmake/OptionsGTK.cmake
+++ Source/cmake/OptionsGTK.cmake
@@ -471,10 +471,11 @@ endmacro()
 # CMake does not automatically add --whole-archive when building shared objects from
 # a list of convenience libraries. This can lead to missing symbols in the final output.
 # We add --whole-archive to all libraries manually to prevent the linker from trimming
-# symbols that we actually need later. (--whole-archive isn't an option on XCode's
-# linker, though.)
+# symbols that we actually need later. With ld64 on darwin, we use -all_load instead.
 macro(ADD_WHOLE_ARCHIVE_TO_LIBRARIES _list_name)
-    if (NOT CMAKE_SYSTEM_NAME MATCHES "Darwin")
+    if (CMAKE_SYSTEM_NAME MATCHES "Darwin")
+        list(APPEND ${_list_name} -Wl,-all_load)
+    else ()
         foreach (library IN LISTS ${_list_name})
           list(APPEND ${_list_name}_TMP -Wl,--whole-archive ${library} -Wl,--no-whole-archive)
         endforeach ()
-- 
2.7.0


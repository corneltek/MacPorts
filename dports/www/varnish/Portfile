# $Id$

PortSystem	      1.0

name		      varnish
epoch                 20110709
version               3.0.3
revision              1
categories	      www
license               BSD zlib
platforms	      darwin
maintainers	      wohner.eu:normen

description	      Varnish is a state-of-the-art, high-performance HTTP accelerator
long_description      Varnish was written from the ground up to be a high \
		      performance caching reverse proxy.

homepage	      http://www.varnish-cache.org
master_sites	      http://repo.varnish-cache.org/source/

checksums             rmd160 a911a2637ef26607aad8a1c34a83bc797a15235d \
                      sha256 2d37d18d952f58b208ac3a0706d4d3e4c0de304b1fcc9df5019571c75f148ab2

depends_build         port:pkgconfig

depends_lib           port:pcre

startupitem.create    yes
startupitem.start     "${prefix}/share/${name}/varnish.init start"
startupitem.stop      "${prefix}/share/${name}/varnish.init stop"

post-destroot {
    # create dir
    xinstall -d -m 755 ${destroot}${prefix}/share/${name}

    # copy files
    xinstall -m 644 ${filespath}/varnish.conf.in ${destroot}${prefix}/etc/${name}/varnish.conf.default
    xinstall -m 755 ${filespath}/varnish.init.in ${destroot}${prefix}/share/${name}/${name}.init
    xinstall -m 755 ${filespath}/varnish-vcl-reload.in ${destroot}${prefix}/sbin/varnish-vcl-reload

    # replace @PREFIX@ to ${prefix}
    reinplace "s|@PREFIX@|${prefix}|g" \
        ${destroot}${prefix}/etc/${name}/varnish.conf.default \
        ${destroot}${prefix}/share/${name}/${name}.init \
        ${destroot}${prefix}/sbin/varnish-vcl-reload

    file rename ${destroot}${prefix}/etc/${name}/default.vcl ${destroot}${prefix}/etc/${name}/default.vcl.default
}

post-activate {
    if {![file exists ${prefix}/etc/${name}/default.vcl]} {
        file copy ${prefix}/etc/${name}/default.vcl.default \
            ${prefix}/etc/${name}/default.vcl
    }
    if {![file exists ${prefix}/etc/${name}/varnish.conf]} {
        file copy ${prefix}/etc/${name}/varnish.conf.default \
            ${prefix}/etc/${name}/varnish.conf
    }

    # dirs nedded to run varnish
    xinstall -d -m 755 -o nobody -g nobody ${prefix}/var/${name}
    xinstall -d -m 755 -o nobody -g nobody ${prefix}/var/run/${name}
}

livecheck.url      ${master_sites}
livecheck.type     regex
livecheck.regex    ${name}-(\\d+\\.\\d+\\.\\d+).tar.gz
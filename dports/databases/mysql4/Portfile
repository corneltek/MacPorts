# $Id: Portfile,v 1.2 2003/10/24 09:12:19 fkr Exp $

PortSystem 1.0
name		mysql4
version	 	4.0.15a
categories	databases
maintainers 	bchesneau@mac.com	
description	Multithreaded SQL database server
long_description	MySQL is an open-source, multi-threaded SQL database \
			with a command syntax very similar to mSQL.
homepage		http://www.mysql.com/
platforms		darwin
master_sites	ftp://ftp.sunet.se/pub/unix/databases/relational/mysql/Downloads/MySQL-4.0 \
		http://mysql-mirror.free.fr/Downloads/MySQL-4.0 \
 		ftp://ftp.FreeBSD.org/pub/FreeBSD/distfiles

set filename	mysql-${version}${extract.sufx}
distfiles	${filename}
distname	mysql-${version}
extract.only	${filename}
checksums	md5 45ee33e80667bb7af3fd6ea8cd1f264c

variant darwin {
	depends_lib-append		lib:libdl.1:dlcompat
}

set dbdir	${prefix}/var/db/mysql

configure.env	LDFLAGS=-L${prefix}/lib\\ -lncurses \
		CPPFLAGS=-I${prefix}/include


configure.args 	--sysconfdir=${prefix}/etc/mysql4 --without-bench \
		--mandir=${prefix}/share/man --infodir=${prefix}/share/info


pre-configure {
	if { ![variant_isset server] } {
		configure.args-append --without-server
	}
}

variant innodb {
	configure.args-append --with-innodb
}

variant debug {
	configure.args-append --with-debug
}

variant server	{
 	depends_run path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup
 	configure.args-append --localstatedir=${dbdir} --with-unix-socket-path=${prefix}/var/run/mysqld/mysqld.sock 
	
}

pre-destroot	{ 

		addgroup mysql
		set gid [existsgroup mysql]
		adduser mysql gid=${gid} realname=MySQL\ Server
		
		if { [variant_isset server] } {
			system "install -o mysql -g mysql -m 775 -d ${destroot}${dbdir}"
			
			file mkdir ${destroot}${prefix}/var/run/mysqld
			system "touch ${destroot}${prefix}/var/run/mysqld/.turd"
			system "chown -R mysql:mysql ${destroot}${prefix}/var/run/mysqld"
		}
		
		
		file mkdir ${destroot}${prefix}/var/log/mysql
		system "touch ${destroot}${prefix}/var/log/mysql/.turd"  
        	system "chown mysql:mysql ${destroot}${prefix}/var/log/mysql"
        
}

post-destroot {
		
		file mkdir ${destroot}${prefix}/etc/mysql4
		system "cp ${portpath}/files/my.cnf ${destroot}${prefix}/etc/mysql4/my.cnf.sample"
		reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/mysql4/my.cnf.sample
			
		if { [variant_isset server] } {
			
			system "install -o root -m 755 -d ${destroot}${prefix}/etc/rc.d"
			system "install -o root -m 755 -c ${portpath}/files/mysql4.sh ${destroot}${prefix}/etc/rc.d/"
			reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/rc.d/mysql4.sh
		}
		
}

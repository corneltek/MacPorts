# $Id: Portfile,v 1.1 2003/07/19 21:45:03 fkr Exp $

PortSystem 1.0
name            openldap
version         2.1.22
categories      database
maintainers     bchesneau@mac.com
description     OpenLDAP Software 
long_description	OpenLDAP Software is an open source implementation \
			of the Lightweight Directory Access Protocol.  

platforms       darwin freebsd
master_sites    ftp://ftp.OpenLDAP.org/pub/OpenLDAP/openldap-release/ \
		http://www.PlanetMirror.com/pub/openldap/openldap-release/ 
distfiles	${name}-${version}.tgz
checksums	md5 391512053eded93e73ffa0d377ce272a

depends_lib	lib:libdb-4.1:db4 \
		bin:perl:perl5.8

depends_run 	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

configure.env   LDFLAGS="-L${prefix}/lib -L/usr/lib" \
		CPPFLAGS="-I${prefix}/include -I${prefix}/include/db4 -I/usr/include/openssl" \
		LANG=C

configure.args	--mandir=${prefix}/share/man \
		--localstatedir=${prefix}/var/run \

variant darwin {
        depends_lib-append      lib:libdl.1:dlcompat
}

variant ipv6 {
	configure.args-append --enable-ipv6
}

variant ssl {
	depends_lib-append	lib:libssl.0.9:openssl
	configure.args-append --with-tls
}

variant tcpd {
	configure.args-append --enable-wrappers
}

pre-configure {
	if { ![variant_isset ipv6]} {
		configure.args-append --disable-ipv6
	}
	if { ![variant_isset ssl]} {
		configure.args-append --without-tls
	}

	if { ![variant_isset tcpd]} {
		configure.args-append --disable-wrappers
	}
}

pre-build {
	system "cd ${workpath}/${worksrcdir} && \
			make depend"
}

pre-install {
	# should be in pre-deploy....
	addgroup ldap
	set gid [existsgroup ldap]
	adduser ldap gid=${gid}
}

post-install {
	file mkdir ${destroot}${prefix}/var/run
	system "install -o ldap -g ldap -m 700 -d ${destroot}${prefix}/var/run/openldap-data"
	#since post-deploy doesn't exist
	system "install -o ldap -g ldap -m 700 -d ${prefix}/var/run/openldap-data"

        file mkdir ${destroot}${prefix}/etc/rc.d
        system "install -o root -m 755 -c \
                      ${portpath}/files/*.sh ${destroot}${prefix}/etc/rc.d"
	reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/rc.d/slapd.sh }

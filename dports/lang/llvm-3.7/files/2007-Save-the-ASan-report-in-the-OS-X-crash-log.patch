From b82505f69186c22d06ea81ac59b2fe5608f8c02c Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Sun, 25 Oct 2015 16:03:00 -0700
Subject: [PATCH 2007/2007] Save the ASan report in the OS X crash log

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
(cherry picked from commit c00bd67ad0f1dd933d8f962b9e4be1de1446465c)
---
 lib/asan/asan_report.cc | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git llvm_release_37/projects/compiler-rt/lib/asan/asan_report.cc macports_release_37/projects/compiler-rt/lib/asan/asan_report.cc
index c1681e6..b736df4 100644
--- llvm_release_37/projects/compiler-rt/lib/asan/asan_report.cc
+++ macports_release_37/projects/compiler-rt/lib/asan/asan_report.cc
@@ -23,6 +23,18 @@
 #include "sanitizer_common/sanitizer_stackdepot.h"
 #include "sanitizer_common/sanitizer_symbolizer.h"
 
+// Apple CrashReporter support.
+#ifdef __APPLE__
+extern "C" {
+static char __crashreporter_info_buff__[1 << 16] = { 0 };
+static const char *__crashreporter_info__ __attribute__((__used__)) = &__crashreporter_info_buff__[0];
+asm (".desc ___crashreporter_info__, 0x10");
+
+#include <string.h>
+#define CRSetCrashLogMessage(msg) strlcpy(__crashreporter_info_buff__, msg, sizeof(__crashreporter_info_buff__));
+}
+#endif
+
 namespace __asan {
 
 // -------------------- User-specified callbacks ----------------- {{{1
@@ -45,6 +57,16 @@ static bool report_happened = false;
 static ReportData report_data = {};
 
 void AppendToErrorMessageBuffer(const char *buffer) {
+#if __APPLE__
+  // For the Apple CrashReporter support: Always store reports into buffer.
+  if (!error_message_buffer) {
+    error_message_buffer_size = 1 << 16;
+    error_message_buffer =
+        (char*)MmapOrDie(error_message_buffer_size, __func__);
+    error_message_buffer_pos = 0;
+  }
+#endif
+
   if (error_message_buffer) {
     uptr length = internal_strlen(buffer);
     CHECK_GE(error_message_buffer_size, error_message_buffer_pos);
@@ -663,6 +685,11 @@ class ScopedInErrorReport {
     // Print memory stats.
     if (flags()->print_stats)
       __asan_print_accumulated_stats();
+
+#ifdef __APPLE__
+    CRSetCrashLogMessage(error_message_buffer);
+#endif
+
     if (error_report_callback) {
       error_report_callback(error_message_buffer);
     }
-- 
2.6.2


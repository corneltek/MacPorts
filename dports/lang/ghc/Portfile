# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           active_variants 1.1

name                ghc
# Do not update GHC separate from Haskell Platform.
# When updating GHC, make sure to revbump all Haskell ports.
version             7.8.3
categories          lang haskell
maintainers         gmail.com:kitchen.andy cal openmaintainer
license             BSD
platforms           darwin

description The Glorious Glasgow Haskell Compilation System
long_description    \
        The Glasgow Haskell Compiler is a robust,       \
        fully-featured, optimising compiler and interactive \
        environment for Haskell 98, GHC compiles Haskell to \
        either native code or C.  It implements numerous    \
        experimental language extensions to Haskell 98,     \
        for example: concurrency, a foreign language interface, \
        multi-parameter type classes, scoped type variables,    \
        existential and universal quantification, unboxed   \
        types, exceptions, weak pointers, and so on.        \
        GHC comes with a generational garbage collector,    \
        and a space and time profiler.

homepage        http://haskell.org/${name}
master_sites    ${homepage}/dist/${version}/
distname        ${name}-${version}-src
worksrcdir      ${name}-${version}

use_bzip2       yes

distfiles       ${name}-${version}-src${extract.suffix} \
                ${name}-${version}-testsuite${extract.suffix}

checksums       ghc-7.8.3-src.tar.bz2 \
                rmd160  464d31d924a8c1e23e94b3cae810c4e41dad4b75 \
                sha256  2358826f8424bf571dcc313bd882422fe108a340d6e37db4339ff6d5d6ac3f37 \
                ghc-7.8.3-testsuite.tar.bz2 \
                rmd160  abc39b71e2f3926b80c681428c447f39599d7d83 \
                sha256  9cfef874adf5b895701ae52e507f07049a64246af120ac15200e7bf612521122

depends_build   port:ghc-bootstrap \
                port:libxslt

depends_lib     port:gmp           \
                port:ncurses       \
                port:libiconv      \
                port:llvm-3.5

patchfiles      patch-configure-workaround-bsdsed-incompatibility.diff \
                patch-configure-disable-docs.diff \
                patch-unix_lib_osx_sandbox_compatibility.diff

livecheck.type  none
test.run        yes

set bootstraproot ${prefix}/share/ghc-bootstrap
set llvmPrefix  ${prefix}/libexec/llvm-3.5
configure.args  --with-ghc=${bootstraproot}/bin/ghc     \
                --with-iconv-includes=${prefix}/include \
                --with-iconv-libraries=${prefix}/lib    \
                --with-gmp-includes=${prefix}/include   \
                --with-gmp-libraries=${prefix}/lib      \
                --with-gcc="${configure.cc}"            \
                --with-llc=${llvmPrefix}/bin/llc        \
                --with-opt=${llvmPrefix}/bin/opt


# OK so because the bootstrap binary has been prebuilt for libraries
# in /usr/lib we search these before macports stuff to prevent
# link errors, ghc _should_ actually compile itself in stage2
# using paths from the command line arguments
compiler.cpath /usr/include
compiler.library_path /usr/lib

build.args      VERBOSE=1
destroot.args   VERBOSE=1

pre-activate {
    set obsoletes [list]

    # Legacy port deactivation hack added 2012-12-08, hs-platform-ghc no longer exists
    lappend obsoletes hs-platform-ghc
    # Legacy port deactivation hack added 2013-08-11, hs-process is provided by base
    lappend obsoletes hs-process
    # Legacy port deactivation hack added 2013-08-14, hs-template-haskell is provided by base
    lappend obsoletes hs-template-haskell
    # Legacy port deactivation hack added 2015-01-05, hs-transformers and hs-xhtml are provided by base
    lappend obsoletes hs-transformers
    lappend obsoletes hs-xhtml

    foreach obsolete $obsoletes {
        if {![catch {set obsolete_installed [lindex [registry_active $obsolete] 0]}]} {
            # $obsolete is installed and active
            # force deactivation
            registry_deactivate_composite $obsolete "" [list ports_nodepcheck 1]
        }
    }
}

post-activate {
    set libprefix "${prefix}/lib/${name}-${version}"
    ## delete old ${prefix}/lib/ghc-${version} directories
    #foreach fullpath [glob -directory ${prefix}/lib ghc-*] {
    #    if {$fullpath ne $libprefix} {
    #        ui_info "Cleaning up remnant GHC library directory ${fullpath}"
    #        delete $fullpath
    #    }
    #}

    catch {system "${prefix}/bin/ghc-pkg -v recache"}
}

# $Id$

PortSystem              1.0
PortGroup               compiler_blacklist_versions 1.0

name                    libcxx
version                 3.4.2
epoch                   1
categories              lang
platforms               darwin
license                 MIT NCSA
maintainers             jeremyhu openmaintainer
description             libc++ is a new implementation of the C++ standard library, targeting C++11
long_description        ${description}

homepage                http://libcxx.llvm.org/

master_sites            http://www.llvm.org/releases/${version}/
 
extract.suffix          .src.tar.gz
worksrcdir              ${name}-${version}.src

checksums               rmd160  7984caf2d055ea967544107ae1f948c77556d764 \
                        sha256  826543ee2feb5d3313b0705145255ebb2ed8d52eace878279c2525ccde6e727c

variant universal {}
use_configure no

set root_path ${prefix}/var/host/${name}-${version}-${revision}

if {${os.major} >= 11} {
    fetch {}
    build {}
    destroot {
        xinstall -d ${destroot}${prefix}/share/doc/${name}
        system "echo ${name} is an empty port on this OS version because the functionality is already provided by the OS. > ${destroot}${prefix}/share/doc/${name}/README.txt"
    }
} elseif {${os.major} < 10} {
    pre-fetch {
        ui_error "${name} is not supported on Leopard or earlier."
        error "unsupported platform"
    }
} else {
    # 3.5 and 3.6 are blacklisted to prevent dependency cycles
    compiler.blacklist *gcc* {clang < 100} macports-clang-3.5 macports-clang-3.6

    depends_lib port:libcxxabi

    supported_archs i386 x86_64

    build.dir ${worksrcpath}/lib
    build.cmd ./buildit
    build.env-append \
        CC="${configure.cc}" \
        CXX="${configure.cxx}" \
        RC_XBS=1 \
        RC_CFLAGS="[get_canonical_archflags]" \
        TRIPLE="-apple-darwin${os.major}"

    # We want to use the host's libc++ everywhere because we want to ensure
    # that only *ONE* copy of this library is in any process's address space.
    # On newer OS versions (Lion+), this port does not install anything.  On
    # Snow Leopard, this port provides this library in /usr for binary
    # compatibility with Lion and later.

    destroot {
        xinstall -m 755 -d ${destroot}${root_path}/usr/lib
        xinstall -m 755 ${worksrcpath}/lib/libc++.1.dylib ${destroot}${root_path}/usr/lib
        ln -s libc++.1.dylib ${destroot}${root_path}/usr/lib/libc++.dylib
    }

    post-activate {
        system "ditto ${root_path} /"
    }
}

livecheck.type none

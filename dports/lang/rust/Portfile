# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=portfile:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                rust
version             0.5
revision            1
categories          lang devel
platforms           darwin
supported_archs     i386 x86_64
license             {MIT Apache-2} BSD zlib NCSA Permissive
maintainers         g5pw openmaintainer

description         Compiler for the Rust programming language
long_description    This is a compiler for Rust, including standard \
                    libraries, tools and documentation.
homepage            http://www.rust-lang.org

master_sites        http://dl.rust-lang.org/dist
checksums           rmd160  b4988da7be984aa1337f4076e96e6d0c72e3170d \
                    sha256  d326d22707f0562d669c11efbc33ae812ddbf76ab78f07087fc5beb095a8928a

patchfiles          patch-configure.diff
post-patch {
    reinplace "s/__BUILD_ARCH__/${configure.build_arch}/g" \
        ${worksrcpath}/configure
}

configure.args      --disable-docs

compiler.blacklist  gcc-3.3 gcc-4.0 gcc-4.2 \
                    apple-gcc-4.0 apple-gcc-4.2 \
                    llvm-gcc-4.2 macports-llvm-gcc-4.2 \
                    macports-gcc-4.2 macports-gcc-4.3 \
                    macports-clang-2.9

# Use MacPorts' clang as fallback compiler.
# TODO: Remove when base fallback lists are updated (2.2?).
compiler.fallback-append            macports-clang-3.2
if {${configure.compiler} == "macports-clang-3.2"} {
    depends_build-append            port:clang-3.2
    depends_skip_archcheck-append   clang-3.2
}

if {[string match *clang* ${configure.compiler}]} {
    configure.args-append   --enable-clang
}

configure.universal_args-delete \
                    --disable-dependency-tracking

# There's a makefile that ignores the configure script CC options, this makes \
# it behave.
build.args-append   CC=${configure.cc} \
                    CXX=${configure.cxx} \
                    CPP=${configure.cpp}

livecheck.url       ${homepage}/
livecheck.regex     "/release-(\\d\.\\d)/"

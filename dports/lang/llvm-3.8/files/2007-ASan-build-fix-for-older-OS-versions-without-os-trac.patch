From 7cd92c21dd373486584066fe4630b10c9bbb85b7 Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Thu, 29 Oct 2015 00:06:52 -0700
Subject: [PATCH 2007/2008] ASan build fix for older OS versions without
 os/trace.h

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 lib/sanitizer_common/sanitizer_mac.cc | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
index 951a48a..49e0c7c 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
@@ -43,7 +43,14 @@ extern char **environ;
 #include <mach-o/dyld.h>
 #include <mach/mach.h>
 #include <mach/vm_statistics.h>
+
+#if __has_include(<os/trace.h>)
+#define SANITIZER_OS_TRACE 1
 #include <os/trace.h>
+#else
+#define SANITIZER_OS_TRACE 0
+#endif
+
 #include <pthread.h>
 #include <sched.h>
 #include <signal.h>
@@ -381,6 +388,7 @@ void WriteOneLineToSyslog(const char *s) {
 }
 
 void LogFullErrorReport(const char *buffer) {
+#if SANITIZER_OS_TRACE
   // Log with os_trace. This will make it into the crash log.
   if (GetMacosVersion() >= MACOS_VERSION_MAVERICKS) {
     // os_trace requires the message (format parameter) to be a string literal.
@@ -399,6 +407,7 @@ void LogFullErrorReport(const char *buffer) {
     if (common_flags()->log_to_syslog)
       os_trace("Consult syslog for more information.");
   }
+#endif
 
   // Log to syslog.
   // The logging on OS X may call pthread_create so we need the threading
-- 
2.6.2


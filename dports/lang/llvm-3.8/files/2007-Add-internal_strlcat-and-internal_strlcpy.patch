From 96bd13f1607e5ef51453571ab235d25441c3c67e Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Thu, 29 Oct 2015 09:36:42 -0700
Subject: [PATCH 2007/2009] Add internal_strlcat and internal_strlcpy

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 lib/sanitizer_common/sanitizer_libc.cc | 24 ++++++++++++++++++++++++
 lib/sanitizer_common/sanitizer_libc.h  |  2 ++
 2 files changed, 26 insertions(+)

diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.cc macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.cc
index 43e4546..d346350 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.cc
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.cc
@@ -175,6 +175,19 @@ uptr internal_strlen(const char *s) {
   return i;
 }
 
+uptr internal_strlcat(char *dst, const char *src, uptr maxlen) {
+  const uptr srclen = internal_strlen(src);
+  const uptr dstlen = internal_strnlen(dst, maxlen);
+  if (dstlen == maxlen) return maxlen+srclen;
+  if (srclen < maxlen-dstlen) {
+      internal_memcpy(dst+dstlen, src, srclen+1);
+  } else {
+      internal_memcpy(dst+dstlen, src, maxlen-dstlen-1);
+      dst[maxlen-1] = '\0';
+  }
+  return dstlen + srclen;
+}
+
 char *internal_strncat(char *dst, const char *src, uptr n) {
   uptr len = internal_strlen(dst);
   uptr i;
@@ -184,6 +197,17 @@ char *internal_strncat(char *dst, const char *src, uptr n) {
   return dst;
 }
 
+uptr internal_strlcpy(char *dst, const char *src, uptr maxlen) {
+  const uptr srclen = internal_strlen(src);
+  if (srclen < maxlen) {
+    internal_memcpy(dst, src, srclen+1);
+  } else if (maxlen != 0) {
+    internal_memcpy(dst, src, maxlen-1);
+    dst[maxlen-1] = '\0';
+  }
+  return srclen;
+}
+
 char *internal_strncpy(char *dst, const char *src, uptr n) {
   uptr i;
   for (i = 0; i < n && src[i]; i++)
diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.h macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.h
index 99de140..df28677 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.h
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_libc.h
@@ -43,8 +43,10 @@ uptr internal_strcspn(const char *s, const char *reject);
 char *internal_strdup(const char *s);
 char *internal_strndup(const char *s, uptr n);
 uptr internal_strlen(const char *s);
+uptr internal_strlcat(char *dst, const char *src, uptr maxlen);
 char *internal_strncat(char *dst, const char *src, uptr n);
 int internal_strncmp(const char *s1, const char *s2, uptr n);
+uptr internal_strlcpy(char *dst, const char *src, uptr maxlen);
 char *internal_strncpy(char *dst, const char *src, uptr n);
 uptr internal_strnlen(const char *s, uptr maxlen);
 char *internal_strrchr(const char *s, int c);
-- 
2.6.2


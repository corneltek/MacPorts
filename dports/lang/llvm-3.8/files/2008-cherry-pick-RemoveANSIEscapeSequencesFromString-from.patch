From ea31f59f9ca1522479010f0cf62897a601b29a8a Mon Sep 17 00:00:00 2001
From: Anna Zaks <ganna@apple.com>
Date: Thu, 29 Oct 2015 09:56:12 -0700
Subject: [PATCH 2008/2009] cherry-pick RemoveANSIEscapeSequencesFromString
 from master

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
(cherry picked from commit 40a6da60a1a29ef72a2f89eb42ea9543b295bc81)
---
 lib/sanitizer_common/sanitizer_common.cc | 34 ++++++++++++++++++++++++++++++++
 lib/sanitizer_common/sanitizer_common.h  |  1 +
 2 files changed, 35 insertions(+)

diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.cc macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.cc
index b40a457..ba9779b 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.cc
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.cc
@@ -295,6 +295,40 @@ void ReportErrorSummary(const char *error_type, const AddressInfo &info) {
 }
 #endif
 
+// Removes the ANSI escape sequences from the input string (in-place).
+void RemoveANSIEscapeSequencesFromString(char *str) {
+  if (!str)
+    return;
+
+  // We are going to remove the escape sequences in place.
+  char *s = str;
+  char *z = str;
+  while (*s != '\0') {
+    CHECK_GE(s, z);
+    // Skip over ANSI escape sequences with pointer 's'.
+    if (*s == '\033' && *(s + 1) == '[') {
+      s = internal_strchrnul(s, 'm');
+      if (*s == '\0') {
+        break;
+      }
+      s++;
+      continue;
+    }
+    // 's' now points at a character we want to keep. Copy over the buffer
+    // content if the escape sequence has been perviously skipped andadvance
+    // both pointers.
+    if (s != z)
+      *z = *s;
+
+    // If we have not seen an escape sequence, just advance both pointers.
+    z++;
+    s++;
+  }
+
+  // Null terminate the string.
+  *z = '\0';
+}
+
 void LoadedModule::set(const char *module_name, uptr base_address) {
   clear();
   full_name_ = internal_strdup(module_name);
diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.h macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.h
index 43cd2d0..7cc7ac3 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.h
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_common.h
@@ -162,6 +162,7 @@ void SetLowLevelAllocateCallback(LowLevelAllocateCallback callback);
 // IO
 void RawWrite(const char *buffer);
 bool ColorizeReports();
+void RemoveANSIEscapeSequencesFromString(char *buffer);
 void Printf(const char *format, ...);
 void Report(const char *format, ...);
 void SetPrintfAndReportCallback(void (*callback)(const char *));
-- 
2.6.2


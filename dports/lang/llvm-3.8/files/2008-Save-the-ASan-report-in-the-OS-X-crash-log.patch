From 88dd2b10bcb87f6664a8e4784afe3876cd0c4cf4 Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Thu, 29 Oct 2015 00:26:24 -0700
Subject: [PATCH 2008/2008] Save the ASan report in the OS X crash log

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 lib/sanitizer_common/sanitizer_mac.cc | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
index 49e0c7c..3f22d2f 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
@@ -62,6 +62,12 @@ extern char **environ;
 #include <sys/types.h>
 #include <unistd.h>
 
+extern "C" {
+static char __crashreporter_info_buff__[1 << 16] = { 0 };
+static const char *__crashreporter_info__ __attribute__((__used__)) = &__crashreporter_info_buff__[0];
+asm (".desc ___crashreporter_info__, 0x10");
+}
+
 namespace __sanitizer {
 
 #include "sanitizer_syscall_generic.inc"
@@ -409,6 +415,13 @@ void LogFullErrorReport(const char *buffer) {
   }
 #endif
 
+  // Save to CrashReporter if we're aborting
+  if (common_flags()->abort_on_error) {
+    internal_strncpy(__crashreporter_info_buff__, buffer, sizeof(__crashreporter_info_buff__));
+    __crashreporter_info_buff__[sizeof(__crashreporter_info_buff__)-1] = '\0';
+    RemoveANSIEscapeSequencesFromString(__crashreporter_info_buff__);
+  }
+
   // Log to syslog.
   // The logging on OS X may call pthread_create so we need the threading
   // environment to be fully initialized. Also, this should never be called when
-- 
2.6.2


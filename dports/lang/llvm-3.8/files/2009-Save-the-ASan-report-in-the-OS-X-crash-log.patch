From cd722f6af128170af07c4a102c3621f4eb409884 Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Thu, 29 Oct 2015 00:26:24 -0700
Subject: [PATCH 2009/2009] Save the ASan report in the OS X crash log

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 lib/sanitizer_common/sanitizer_mac.cc | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
index 49e0c7c..dd51813 100644
--- llvm_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
+++ macports_master/projects/compiler-rt/lib/sanitizer_common/sanitizer_mac.cc
@@ -62,6 +62,11 @@ extern char **environ;
 #include <sys/types.h>
 #include <unistd.h>
 
+extern "C" {
+static char *__crashreporter_info__ __attribute__((__used__)) = NULL;
+asm (".desc ___crashreporter_info__, 0x10");
+}
+
 namespace __sanitizer {
 
 #include "sanitizer_syscall_generic.inc"
@@ -409,6 +414,12 @@ void LogFullErrorReport(const char *buffer) {
   }
 #endif
 
+  // Save to CrashReporter if we're aborting
+  if (common_flags()->abort_on_error) {
+    __crashreporter_info__ = internal_strdup(buffer);
+    RemoveANSIEscapeSequencesFromString(__crashreporter_info__);
+  }
+
   // Log to syslog.
   // The logging on OS X may call pthread_create so we need the threading
   // environment to be fully initialized. Also, this should never be called when
-- 
2.6.2


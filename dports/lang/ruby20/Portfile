# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           select 1.0

name                ruby20
version             2.0.0-p247
revision            1

categories          lang ruby
maintainers         kimuraw openmaintainer
platforms           darwin

description         Powerful and clean object-oriented scripting language
long_description    Ruby is the interpreted scripting language for quick \
                    and easy object-oriented programming. It has many \
                    features to process text files and to do system \
                    management tasks (as in Perl). It is simple, \
                    straight-forward, extensible, and portable.

homepage            http://www.ruby-lang.org/
license             {Ruby BSD}

master_sites        ruby:2.0
use_bzip2           yes
distname            ruby-${version}

checksums           md5 60913f3eec0c4071f44df42600be2604 \
                    rmd160 4a3b6653f17c145c6938c538022c199f830a0dee \
                    sha1 9d3e5758c87a2c8016aec246f278b7551f8cb675 \
                    sha256 08e3d4b85b8a1118a8e81261f59dd8b4ddcfd70b6ae554e0ec5ceb99c3185e8a
use_parallel_build  no

depends_lib         port:readline \
                    port:openssl \
                    port:zlib \
                    port:ncurses \
                    port:libyaml \
                    port:libffi \
                    port:gdbm
depends_run         port:ruby_select
depends_build       port:pkgconfig
depends_skip_archcheck pkgconfig

select.group        ruby
select.file         ${filespath}/ruby20

configure.args      --enable-shared \
                    --disable-install-doc \
                    --mandir="${prefix}/share/man" \
                    --enable-pthread \
                    --without-tk \
                    --with-opt-dir="${prefix}" \
                    --program-suffix=2.0 \
                    --with-rubylibprefix=${prefix}/lib/ruby2.0

# Ignore minor version for archdir, like i686-darwin9.
# Port "ruby" and "ruby19" does the same.
configure.env-append UNAME_RELEASE=${os.major}

# configure: fix build error at verconf.h. patch from trunk.
# ext/tk/extconf.rb: fix build error with tk variant
# ruby-list:49520: fix mactk variant does not work
patchfiles          patch-ext-tk-extconf.rb.diff \
                    patch-ruby-list-49520.diff

# Add the architecture flag as required
if {[info exists build_arch] && ${build_arch} != ""} {
    configure.args-append "--with-arch=${build_arch}"
}

post-destroot {
    foreach type {site vendor} {
            set libdir ${destroot}${prefix}/lib/ruby2.0/${type}_ruby/2.0.0
            xinstall -m 0755 -d ${libdir}
    }

    foreach subdir [exec find ${libdir} -type d -empty] {
            destroot.keepdirs-append ${subdir}
    }

    # install destination of commands from port:rb-*
    xinstall -m 0755 -d ${destroot}${prefix}/libexec/ruby2.0
    destroot.keepdirs-append ${destroot}${prefix}/libexec/ruby2.0

#    # error at activate, for these case sensitive files
#   foreach rdoc {Exception2MessageMapper/fail-i.yaml \
#                 REXML/Parsers/XPathParser/predicate-i.yaml} {
#       if {[file exists ${destroot}${prefix}/share/ri1.9/1.9.1/system/${rdoc}]} {
#           delete ${destroot}${prefix}/share/ri1.9/1.9.1/system/${rdoc}
#       }
#   }
}

variant doc description "Install rdoc indexes and C API documents" {
        configure.args-delete   --disable-install-doc
}

variant tk conflicts mactk description "Build using MacPorts Tk" {
        configure.args-delete   --without-tk
        configure.args-append   --with-tk --disable-tcltk-framework
        depends_lib-append      port:tcl \
                                port:tk
}

variant mactk conflicts tk description "Build using Mac OS X Tk Framework" {
        configure.args-delete   --without-tk
        configure.args-append   --enable-tcltk-framework
}

variant universal {
        # use ruby built-in universal mechanism.
        configure.args-append   --with-arch=[join ${universal_archs} ,]
        # clear macports' universal flags
        configure.universal_cflags
        configure.universal_cppflags
        configure.universal_cxxflags
        configure.universal_ldflags
}

livecheck.type  regex
livecheck.url   http://ftp.ruby-lang.org/pub/ruby/2.0/
livecheck.regex ruby-(${version})${extract.suffix}


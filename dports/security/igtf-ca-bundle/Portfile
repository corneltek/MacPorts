# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                igtf-ca-bundle
version             1.57
categories          security net
platforms           darwin
supported_archs     noarch
maintainers         nikhef.nl:dennisvd petr openmaintainer

license             {CCBY-3 Permissive} MPL-1.1+

description         The IGTF trusted certificates and metadata

long_description    \
    The International Grid Trust Federation (IGTF) maintains a list of trust \
    anchors, root certificates and related meta-information for all the \
    accredited authorities, i.e., those that meet or exceed the criteria \
    mentioned in the Authentication Profiles accepted by the IGTF. \
    For a list of those profiles, please refer to the website.

homepage            http://www.igtf.net

master_sites        http://dist.eugridpma.info/distribution/igtf/${version} \
                    http://www.apgridpma.org/distribution/igtf/${version}

distname            igtf-policy-installation-bundle-${version}

checksums           rmd160  aec29316f66b3c2c35fcc391d79ca7322df2bb3e \
                    sha256  6d29e1e893d420d7d42de1faa43ed6cdba98a8693e7d576cf17b9b920a4c8c7f

livecheck.type      regex
livecheck.url       http://dist.eugridpma.info/distribution/igtf
livecheck.regex     ">(\\d+\\.\\d{2})/<"

depends_run          port:fetch-crl

# target directory for certificates
set certdir ${prefix}/etc/grid-security/certificates

configure.args-append \
	--prefix=${destroot}${certdir} \
	--with-profile=classic \
	--with-profile=slcs \
	--with-profile=mics

build {}

post-destroot {
    ln -s ${certdir} ${destroot}${prefix}/share/certificates

    set dest_doc ${destroot}${prefix}/share/doc
    xinstall -d ${dest_doc}
    xinstall -m 644 -W ${worksrcpath} \
        CHANGES	\
        LICENSE	\
        README.txt \
            ${dest_doc}
    # These are added to comply with MPL licensing
    xinstall -m 644 -W  ${portpath}/files \
        LICENSE-CC-BY-3_0 \
        LICENSE-MPL-1_1 \
            ${dest_doc}
}

post-activate {
    ui_msg "Fetching CRLs ..."    
    system "${prefix}/sbin/fetch-crl -v"
}
post-deactivate {
    ui_msg "Purging CRLs ..."
    system "${prefix}/sbin/clean-crl -v -l ${certdir}"

    # cleanup leftover directories
    catch {file delete ${certdir}}
    catch {file delete ${prefix}/etc/grid-security}
}

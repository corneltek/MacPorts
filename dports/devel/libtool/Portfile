# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                libtool
version             2.4.2
revision            5
categories          devel sysutils
platforms           darwin freebsd
# Scripts are GPL-2+, libltdl is LGPL-2+, but all parts that tend to be
# distributed with dependents have a licensing exception that allows
# distribution under the same terms as the rest of the program.
license             libtool
maintainers         larryv

description         The GNU Portable Library Tool
long_description    GNU libtool is a generic library support script. \
                    Libtool hides the complexity of using shared \
                    libraries behind a consistent, portable interface.
homepage            http://www.gnu.org/software/libtool/

if {${os.platform} ne "darwin"} {
    depends_lib     port:grep port:gsed
}

master_sites        gnu
checksums           rmd160  b7153f3f1e1c50d8c04787cafccd4e19af62ec7d \
                    sha256  b38de44862a987293cd3d8dfae1c409d514b6c4e794ebc93648febf9afc38918

# http://trac.macports.org/ticket/32982
patchfiles          allow-stdlib-flag.patch
post-patch {
    # Prevent build from trying to regenerate. This file says nothing
    # about -stdlib.
    touch ${worksrcpath}/doc/libtool.1
}

# Fix detection of MACOSX_DEPLOYMENT_TARGET on Yosemite and later.
patchfiles-append   yosemite-symbol-lookup.patch
post-patch {
    # Prevent build from trying to regenerate. These files don't have
    # anything to do with MACOSX_DEPLOYMENT_TARGET or -undefined.
    touch ${worksrcpath}/aclocal.m4 \
            ${worksrcpath}/Makefile.in \
            ${worksrcpath}/config-h.in \
            ${worksrcpath}/libltdl/aclocal.m4 \
            ${worksrcpath}/libltdl/Makefile.in \
            ${worksrcpath}/libltdl/config-h.in
}

platform darwin {
    configure.env   GREP=/usr/bin/grep \
                    SED=/usr/bin/sed
}
# Don't look for broken compilers (#23684, #32321).
configure.env-append    GCJ=no
configure.fc            no
configure.f77           no

configure.args      --disable-silent-rules \
                    --program-prefix=g

post-destroot {
    set gnubin ${prefix}/libexec/gnubin
    xinstall -d ${destroot}${gnubin}
    ln -s ../../bin/glibtool ${destroot}${gnubin}/libtool
    ln -s ../../bin/glibtoolize ${destroot}${gnubin}/libtoolize

    set docdir ${prefix}/share/doc/${name}
    xinstall -d ${destroot}${docdir}
    xinstall -m 0644 -W ${worksrcpath} AUTHORS COPYING ChangeLog NEWS README THANKS \
        TODO ${destroot}${docdir}
}

test.run            yes
test.target         check

livecheck.type      regex
livecheck.url       http://ftp.gnu.org/gnu/${name}/?C=M&O=D
livecheck.regex     ${name}-(\\d+(?:\\.\\d+)*\[a-z\]?)

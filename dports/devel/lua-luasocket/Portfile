# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name                lua-luasocket
version             3.0_rc1
revision            0
categories          devel
license             MIT
platforms           darwin
maintainers         gmail.com:emmett.shear

description         The luasocket library extends lua with tcp, udp, and dns
long_description    LuaSocket is a Lua extension library that is composed by two parts: \
                    a C core that provides support for the TCP and UDP transport layers, \
                    and a set of Lua modules that add support for functionality commonly \
                    needed by applications that deal with the Internet.

homepage            http://www.cs.princeton.edu/~diego/professional/luasocket/

master_sites        https://github.com/diegonehab/luasocket/archive/
checksums           md5     08bd2f265b244eb4bf5c2c36bf89b759 \
                    sha1    aff9122b26c01487c06a32133df78c1506af350f \
                    rmd160  27357eee7e52f091609f45a0b0fb7e04e9ea2bd8
distname            "v[regsub {_} $version {-}]"
worksrcdir          "luasocket-[regsub {_} $version {-}]"

depends_lib         port:lua
depends_build       path:bin/pkg-config:pkgconfig

livecheck.type      regex
livecheck.url       http://luaforge.net/frs/?group_id=23
livecheck.regex     {luasocket-([0-9.]+)\.tar\.gz}

patchfiles          patch-Makefiles.diff

use_configure       no

post-patch {
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/src/makefile
    reinplace "s|@CC@|${configure.cc}|g" ${worksrcpath}/src/makefile
    reinplace "s|@CFLAGS@|${configure.cppflags} ${configure.cflags}|g" ${worksrcpath}/src/makefile
}

build {
    set lua_version "[exec -- ${prefix}/bin/pkg-config --variable V lua]"
    system "cd ${worksrcpath} && make DEBUG=DEBUG macosx LUAV=${lua_version}"
}

destroot {
    set lua_version "[exec -- ${prefix}/bin/pkg-config --variable V lua]"
    system "cd ${worksrcpath} && make DEBUG=DEBUG LUAV=${lua_version} DESTDIR=${destroot} PREFIX=${prefix} PLAT=macosx install-unix"
}

post-destroot {
    xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
    xinstall -m 755 -d ${destroot}${prefix}/share/examples/${name}

    eval xinstall -m 644 [glob ${worksrcpath}/doc/*] ${destroot}${prefix}/share/doc/${name}
    xinstall -m 644 ${worksrcpath}/LICENSE ${worksrcpath}/NEW \
        ${worksrcpath}/README ${destroot}${prefix}/share/doc/${name}
    file copy ${worksrcpath}/etc ${worksrcpath}/samples ${worksrcpath}/test \
        ${destroot}${prefix}/share/examples/${name}
}

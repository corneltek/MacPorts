PortSystem 1.0
name		perforce
version		02.1
categories	devel
maintainers	eric@opendarwin.org
description	Fast source code management system
long_description	Perforce is a commercial revision control system that can be used gratis for developing free software. (see the WWW page for details). 
platforms	darwin freebsd
master_sites	ftp://www.perforce.com/pub/perforce/r${portversion}/bin.darwinppc/ \
		ftp://www.perforce.com/pub/perforce/r${portversion}/doc/man/
dist_subdir	${portname}
worksrcdir	${portname}
distfiles	p4 p4.1 p4d p4d.1
checksums	p4 md5 e18b1cda0de653e086d23cf97cdf0d04 \
		p4.1 md5 f5ab07d3fe1d8387f7685fca03053461 \
		p4d md5 14c497980766afbaa467ef49bbd2e604 \
		p4d.1 md5 721b40e0e2f5f41e6cfae52450127283
extract		{ system "mkdir -p ${portpath}/${workdir}/${worksrcdir}"
	 	  system "cp ${distpath}/* \
		  ${portpath}/${workdir}/${worksrcdir}/" }
configure	{}
build		{}
install		{ cd ${worksrcpath}
		  system "install -o root -m 755 -d ${prefix}/bin"
		  system "install -o root -m 755 -d ${prefix}/sbin"
		  system "install -o root -m 755 -d ${prefix}/share/man/man1"
		  system "install -o root -m 755 -d ${prefix}/share/man/man8"
		  system "install -o root -m 755 -c p4 ${prefix}/bin"
		  system "install -o root -m 755 -c p4d ${prefix}/sbin"
		  system "install -o root -m 644 -c p4.1 \
		    ${prefix}/share/man/man1"
		  system "install -o root -m 644 -c p4d.1 \
		    ${prefix}/share/man/man8" }

variant server {
depends_run path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

	post-install {
		addgroup perforce
		set gid [existsgroup perforce]
		adduser perforce realname=Perforce\ Server gid=${gid} \
			home=${prefix}/share/perforce shell=/bin/sh
		system "install -o perforce -m 755 -d \
			${prefix}/share/perforce/depot"
		system "install -o perforce -m 644 -c /dev/null \
			${prefix}/share/perforce/log"
		set script [open "${prefix}/etc/rc.d/perforce.sh" w 0755]
		puts $script "#!/bin/sh"
		puts $script "su perforce -c \"${prefix}/sbin/p4d -d -r \
			${prefix}/share/perforce/depot -L \
			${prefix}/share/perforce/log\""
		close $script
		contents-append etc/rc.d/perforce.sh
	}
}

contents	bin/p4 \
		sbin/p4d \
		share/man/man1/p4.1 \
		share/man/man8/p4d.1

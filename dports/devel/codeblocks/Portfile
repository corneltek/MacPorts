# -*- coding: utf-8; mode: tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=2:ts=2:sts=2
# $Id$

PortSystem          1.0
PortGroup           wxWidgets 1.0

name                codeblocks
version             12.11
set release         8629
platforms           darwin freebsd
categories          devel aqua x11
license             GPL-3+
maintainers         afb
description         Open Source, Cross-platform, Free C/C++/D IDE
long_description    Code::Blocks is a free C++ IDE built specifically \
                    to meet the most demanding needs of its users. \
                    It was designed, right from the start, to be \
                    extensible and configurable.

homepage            http://codeblocks.org/
master_sites        http://download.berlios.de/codeblocks/ \
                    sourceforge:codeblocks
distname            ${name}_${version}-1
worksrcdir          ${name}-${version}release${release}
checksums           rmd160  669ff13ce89729d869a4002ef56814020aede0c0 \
                    sha256  af57635b97aa6ea52ba120c5fac2d847c2638d53e6bdb3fdd1561b7fa7ae6ed9

platform darwin {
    if {${os.major} >= 13} {
        depends_lib
        depends_run
        pre-fetch {
            ui_error "$name does not build on Mavericks or later."
            error "unsupported platform"
        }
    }
}

# TODO: apparently more dependencies are needed in this version, please help complete the list (see also the list below)
depends_build       path:bin/pkg-config:pkgconfig
depends_lib         port:boost

# TODO:
# patch-MouseSap-Makefile.diff:                               report upstream
# patch-Makefile.diff:                                        not sure why it is needed
# patch-src-plugins-contrib-lib_finder-librariesdlg.cpp.diff: report upstream
# patch-src-plugins-contrib-profiler-cbprofiler.cpp.diff:     http://developer.berlios.de/patch/index.php?func=detailpatch&patch_id=3496&group_id=5358
# patch-src-plugins-contrib-source_exporter-Makefile.diff:    report upstream
# patch-src-sdk-wxscintilla-src-PlatWX.cpp.diff:              fixed upstream
patchfiles          patch-MouseSap-Makefile.diff \
                    patch-Makefile.diff \
                    patch-src-plugins-contrib-lib_finder-librariesdlg.cpp.diff \
                    patch-src-plugins-contrib-profiler-cbprofiler.cpp.diff \
                    patch-src-plugins-contrib-source_exporter-Makefile.diff \
                    patch-src-sdk-wxscintilla-src-PlatWX.cpp.diff \

# not sure what this patch was used for
#                   patch-sdk-configmanager.cpp

post-destroot {
    # TODO: this might need a review
    system "strip -S ${destroot}${prefix}/bin/codeblocks"
    system "strip -S ${destroot}${prefix}/lib/libcodeblocks*.so || true"
    system "strip -S ${destroot}${prefix}/lib/libcodeblocks*.dylib || true"
    system "strip -S ${destroot}${prefix}/lib/libwxsmithlib*.so || true"
    system "strip -S ${destroot}${prefix}/lib/libwxsmithlib*.dylib || true"
    system "strip -S ${destroot}${prefix}/lib/wxSmithContribItems/lib*.so || true"
    system "strip -S ${destroot}${prefix}/lib/wxSmithContribItems/lib*.dylib || true"
    system "strip -S ${destroot}${prefix}/lib/codeblocks/plugins/*.so"

    set appPath ${destroot}${applications_dir}/CodeBlocks.app/Contents
    xinstall -d -m 0755 ${destroot}${applications_dir}
    xinstall -d -m 0755 ${appPath}
    xinstall -d -m 0755 ${appPath}/Resources
    file copy -force ${worksrcpath}/codeblocks.plist ${appPath}/Info.plist
    foreach {icn} {app cbp csd c cg cpp d f h rc} {
        file copy -force ${worksrcpath}/src/src/resources/icons/${icn}.icns ${appPath}/Resources
    }

    xinstall -d -m 0755 ${appPath}/MacOS
    ln -sf ${prefix}/bin/codeblocks ${appPath}/MacOS/CodeBlocks
    xinstall -d -m 0755 ${appPath}/Resources/share
    ln -sf ${prefix}/share/codeblocks ${appPath}/Resources/share/codeblocks
    xinstall -d -m 0755 ${appPath}/Resources/lib
    ln -sf ${prefix}/lib/codeblocks ${appPath}/Resources/lib/codeblocks

    delete ${destroot}${prefix}/share/applications/codeblocks.desktop
    delete ${destroot}${prefix}/share/icons/hicolor
    delete ${destroot}${prefix}/share/mime/packages/codeblocks.xml
    delete ${destroot}${prefix}/share/pixmaps/codeblocks.png

    # TODO without the following block the app fails to start and throws the following error:
    #
    # Cannot find resources...
    # Code::Blocks was configured to be installed in '/Applications/MacPorts/CodeBlocks.app/Contents/MacOS/share/codeblocks'.
    # Please use the command-line switch '--prefix' or set the CODEBLOCKS_DATA_DIR environment variable to point where Code::Blocks is installed,
    # or try re-installing the application...
    #
    # but this seems like a bug
    xinstall -d -m 0755 ${appPath}/MacOS/share
    ln -sf ${prefix}/share/codeblocks ${appPath}/MacOS/share
}

# TODO: keep the old variants/descriptions?
# variant aqua / x11
# variant aqua conflicts x11 description "Use the wxMac port of wxWidgets"
# variant x11 description "Use the wxGTK port of wxWidgets"

variant aqua {}
variant x11 {}

variant wxwidgets28 conflicts wxgtk28 description {Use 32-bit Carbon-based wxWidgets 2.8} {
    wxWidgets.use           wxWidgets-2.8
    depends_lib-append      port:${wxWidgets.port}
    # NassiShneiderman seems to be broken (http://trac.macports.org/ticket/40389)
    configure.args-append   --with-wxdir=${wxWidgets.wxdir} \
                            --with-contrib-plugins=all,-NassiShneiderman

    if {${wxWidgets.sdk} != ""} {
        configure.sdkroot ${wxWidgets.sdk}
    }
}
variant wxgtk28 conflicts wxwidgets28 description {Use wxWidgets 2.8 with GTK} {
    wxWidgets.use           wxGTK-2.8
    # TODO: someone needs to do a careful check of this list of dependencies
    # codeblocks ends up linking against these, but it is quite possible that:
    # - some of them are also needed when liking against Carbon/Cocoa-based wxWidgets
    # - some of them are only gtk's dependencies and are not used directly in codeblocks at all
    depends_lib-append      port:${wxWidgets.port} \
                            port:atk \
                            port:bzip2 \
                            path:lib/pkgconfig/cairo.pc:cairo \
                            port:expat \
                            port:fontconfig \
                            port:freetype \
                            port:gdk-pixbuf2 \
                            port:gettext \
                            port:glib2 \
                            port:graphite2 \
                            port:gtk2 \
                            port:harfbuzz \
                            port:hunspell \
                            port:libffi \
                            port:libiconv \
                            port:libpixman \
                            port:libpng \
                            port:pango \
                            port:xorg-libX11 \
                            port:xorg-libXau \
                            port:xorg-libXcomposite \
                            port:xorg-libXcursor \
                            port:xorg-libXdamage \
                            port:xorg-libXdmcp \
                            port:xorg-libXext \
                            port:xorg-libXfixes \
                            port:xorg-libXi \
                            port:xorg-libXinerama \
                            port:xorg-libXrandr \
                            port:xorg-libxcb \
                            port:xrender \
                            port:zlib
    # FileManager requires "gamin" to be installed when using wxGTK,
    # so it was disabled for now
    configure.args-append   --with-wxdir=${wxWidgets.wxdir} \
                            --with-contrib-plugins=all,-FileManager
}

if {![variant_isset wxwidgets28] && ![variant_isset wxgtk28]} {
    if {[variant_isset aqua]} {
        default_variants +wxwidgets28
    } elseif {[variant_isset x11]} {
        default_variants +wxgtk28
    } elseif {[vercmp $xcodeversion 4.4] >= 0} {
        default_variants +wxgtk28
    } else {
        default_variants +wxwidgets28
    }
}
